MYSQL数据
==  
 
【MYSQL数据库】  
DBMS 数据库管理系统 database management system  
DBA：负责数据库的规划、设计、协调、维护和管理等工作  
(数据库管理员↑)  

数据：定义-处理-安全-备份-集群    
萌芽：文件系统，使用磁盘文件存储数据  
初级：网状数据库(复杂，条理不清晰)，层次数据库(1对多，有冗余数据)  
中级：关系数据库和结构化查询语言    
高级："关系-对象"型数据库  
数据库系统的架构：  
单机架构/大型主机/终端架构  
主从式架构（C/S）_目前主流/分布式架构  

--文件管理系统的缺点  
编写应用程序不方便；冗余；应用程序依赖性；不支持并发访问；  
数据关联若；无法按用户试图表示数据；无安全控制功能  

--关系型数据库  
关系 ：关系就是二维表，其中：表中的行、列次序并不重要  
行row：表中的每一行，又称为一条记录  
列column：表中的每一列，称为属性，字段  
主键（Primary key）：用于惟一确定一个记录的字段 pk  
#一个表只有一个主键，但可关联到多个字段（列），也叫复合主键  
#表中不会出现相同的一行记录，避免冗余数据  
域domain：属性的取值范围，如，性别只能是‘男’和‘女’两个值  

关系数据库：  
优点：安全可靠，一致，稳定，并发访问，相互关联，较少冗余  
缺点：扩展性差，性能达到一定规模很难保证  
数据库排名：db-engines.com/en/ranking  
RDBMS：  
mysql：mysql，mariaDB，percona server 开源   
oracle ； mssql ； postgreSql ； DB2  
非关系型数据库：no only sql 基于内存，访问速度快，扩展性强  

联系类型：  
1对1 ： 主外键  
1对多 ： 构建第三张表  
多对多 :  通过第三张表分别和原来两张表实现主外键  
#foreign key ：外键 fk   
数据的操作：数据提取：select  
                   数据更新：insert、delete、updata    
数据的约束条件：一组完整性规则的集合  
#实体（行）完整性  entity integrity 主键表实现  
#域（列）完整性 domain integrity  取值范围实现  
#参考完整性  referential integrity    
 
简易数据规划流程：  
第一阶段：收集数据，得到字段  
第二阶段：把字段分类，归入表，建立表的关联  
第三阶段：规范化数据库  
  
范式 (避免冗余数据)  
1NF ：无重复列  
2NF：属性完全依赖于主键，基于前面范式  
3NF：属性不依赖于其它非主属性，基于前面范式   

--SQL 概念  
SQL: Structure Query Language  
结构化查询语言  

约束（显示数据遵守某些规则，保证数据正确，合理）  
主键  一个或多个字段的组合；字段不能为空  pk  
唯一键  一个或多个字段的组合；允许为空；uniq key=uk  
外键：一张表依赖另一张表（主键/唯一键）的关系；foreign key=fk   
检查：字段值在一定范围内  

基本概念  
索引：将表中的一个或多个字段中的数据复制一份另存，并且按特定次序  

排序存储（按顺序排序，适用于大量数据，方便查找）  
关系运算：  
选择：挑选出符合条件的行  
投影：挑选出需要的字段  
连接：表间字段的关联（主外键）  

--数据模型    
raw裸文件系统（101010...）效率更高   
数据抽象：  
物理层：数据存储格式，即RDBMS在磁盘上如何组织文件  
逻辑层：DBA角度，描述存储什么数据，以及数据间存在什么样的关系  
视图层：用户角度，描述DB中的部分数据  
关系模型的分类：  
关系模型  
基于对象的关系模型  
半结构化的关系模型：XML数据(扩展到标记语言)  

官方网址：  
https://www.mysql.com/  
http://mariadb.org/  
https://www.percona.com  
官方文档  
https://dev.mysql.com/doc/  
https://mariadb.com/kb/en/  
https://www.percona.com/software/mysql-database/percona-server  
  
MYSQL的特性  
插件式存储引擎：也称为“表类型”，存储管理器有多种实现版本，功能  
  
和特性可能均略有差别；用户可根据需要灵活选择,Mysql5.5.5开始  
  
innoDB引擎是MYSQL默认引擎  
MyISAM ==> Aria  
InnoDB ==> XtraDB  
单进程，多线程  
诸多扩展和新特性  
提供了较多测试组件    
开源  

--隐藏开机界面用户名 centos6  
cd /etc/gconf/gconf.xml.defaults/  
vim %gconf-tree.xml  
/user_list  搜索该字符，定位↓  
\<default type ="bool" value="false"/> false改成true  

--安装mysql  
1、源代码：编译安装  
2、二进制格式的程序包：展开至特定路径，并经过简单配置后即可使用  
已编译完，并且打包好的二进制文件，处理已编译，其他同上  
3、程序包管理器管理的程序包  

rpm安装mysql-server （centos6）▲  3306端口  mysqld   
yum install mysql-server -y  
mysql_secure_installation 安全设置  
#/etc/rc.d/init.d/mysqld 服务启动脚本    
#/user/libexec/mysqld 主程序  
#/etc/my.cnf  配置文件（可充当服务器/客户端配置文件）  
#/var/lib/mysql/ 数据库路径  
#/var/log/mysqld.log 日志文件  

preinstall 安装脚本  
mysql -u root（不敲默认root） -p -S /var/lib/mysql/mysql.sock  
登录root账号用sock连接myql数据库   -p(password)   -S(sock)  
mysql 默认登录 ↑同上  
vim /etc/my.cnf  更改提示符保存到配置文件  
添加语句块  
[mysql]  客户端配置 （mysqld是服务器配置）  
prompt='\u@[\D]>'   
mysql  -uroot -pcentos -h192.168.34.7 远程连接到7的数据库  


rpm安装mysql-server （centos7 ）▲  
yum install mariadb-server  -y   
#/etc/my.cnf.d/server.cnf 服务器配置文件  
#/usr/lib/systemd/system/mariadb.service 服务名  
#/usr/libexec/mysqld 服务器主程序  
#/etc/my.cnf.d/ 配置文件  
#/var/log/mariadb/mariadb.log  日志文件  
#/var/lib/mysql 数据库数据  

systemctl start mriadb 启动服务  
system hostaneme 查看主机  
mysqladmin ping  查看数据库是否活动  
mysqladmin shutdown 停止服务  
mysqladmin status 查看状态  
mysqld_multi 多实例 多进程  
rm -rf /var/lib/mysql/*  删除数据库信息，重启服务可重新生成  
vim /etc/my.cnf.d/mysql  
vim /etc/my.cnf.d/mysql-clients.cnf 更改提示符保存到配置文件  
\# prompt='\u@[\D]>'   
&:任意字符   _任意单个字符  服务器端命令：加；结束  
mysql用户账号组成：'username'@'host'  
例：user@192.168.34.%  

--客户端命令：  
mysql  默认root登录  
>status 或 \s  查看状态  
>prompt mysql -->  更改提示符为-->  
>prompt \u@[\D]  更改提示符为用户+完整时间  
>use mysql  切换mysql数据库；类似cd  
>help show 查询show命令用法  


>show databases; 查目前支持的数据库；数据库列表  
>select version(); 查看当前数据库版本信息  
>select user(); 查当前登录用户信息  
>select database(); 查当前在哪个数据库   
>show engines; 查询引擎   
>show tables;  显示当前数据库中包含数据列表  
(ls /var/lib/mysql/mysql 对应当前mysql数据库列表↑↑)  
>show tables form test;  
>show databases; 查看当前数据库文件  
>desc user; 查看当前列表的字段  
>select user,host.passwd from user;查询当前账号信息  
mysql < test.sql  命令行添加文本方式执行，并显示结果  
vim test.sql  
select now();  
showdatabases;  
或↓↓↓  
source test.sql  登录mysql账号后执行文本命令，结果同上  
mysql -e 'show database' 命令行直接执行  
  
mysql_secure_installation   安全加固，及口令设置  
请出入当前口令？  
是否设置root口令？      
是否移除匿名用户？   
是否禁用远程登录？  
是否删除test数据库？  
是否从新加载特权表？  让权限立即生效？  
  
mysql -p：口令  登录  
select user,host,password from user;查询账号信息  
(用户名+主机名)  mysql控制登录在某主机的用户功能，默认本地连接  
mysqladmin ping  
mysqladmin shutdown 关闭数据库服务  
sysqladmin status  
ps aux  
完整的用户信息 = 用户名@主机名  
>user@192.168.34.%  允许远程某些主机的IP登录  
_任意的单个字符  
重定向执行命令  ↓（也支持管道）  
vim test.sql  
#show databases;  
#use mysql  
mysql < test.sql 
mysql -e 'show databases' 也支持  
>source  test.sql 也支持  
mysql -D mysql  切换到mysql数据库  
  
mysql客户端可用选项：  
-A, --no-auto-rehash 禁止补全  
-u, --user= 用户名,默认为root  
-h, --host= 服务器主机,默认为localhost  
-p, --passowrd= 用户密码,建议使用-p,默认为空密码  
-P, --port= 服务器端口  
-S, --socket= 指定连接socket文件路径  
-D, --database= 指定默认数据库，相当于use xx  
-C, --compress 启用压缩  
-e “SQL“ 执行SQL命令  
-V, --version 显示版本  
-v --verbose 显示详细信息  
--print-defaults 获取程序默认使用的配置  
>mysql --print-defaults -v  显示配置信息  

--启用网络特性（端口会关闭；维护时可用）  
vim /etc/my.cnf  
[mysqld]  
skip-networking 或 skip-networking=1   
服务重启生效（1/on/true启用  0/off/false禁用）  
  
--创建逻辑卷，并迁移数据库 (/data/mysql数据库路径)  
fdisk  /dev/sda  
#n +1G t 8e  w    
pvcreate  /dev/sda6     
vgcreate vg0 /dev/sda6   
lvcreate -n mayql  -l 100%FREE vg0  
mkfs.xfs /dev/vg0/mysql 
blkid 查看文件系统  
mkdir /data/mysql    
mount /dev/vg0/mysql /data/mysql （保存要写入/etc/fstab文件）  
chown mysql.mysql /data/mysql  
vim /etc/my.cnf  
#datadir=/data/mysql  
systemctl restart mariadb  重启服务  
ls /data/mysql 查看是否迁移  
  

通用二进制格式安装 mariadb-10.2.19 (以编译好的)▲34.17    
(移除mysql，mariadb-hserver）    
通过mariadb.org网站下载    
tar xf mariadb-10.2.19-linux...tar.gz  -C /usr/local 解压到该目录  
ln -s /usr/local/mariadb-10.2.19-linux...  /usr/local/mysql  
\--prefix=/usr/local/mysql (程序文件所在路径)  
chown -R root.root  /usr/local/mysql/  给程序目录添加权限  
useradd -r -s /sbin/nologin -d /data/mysql -C 'mariadb user'    mysql   
创建用户及相关属性  
install -d /data/mysql  -o mysql -g mysql 创建目录和设置权限  
cd /usr/local/mariadb-10.2.19-linux-x86_64/▲    
scripts/mysql_install_db --user=mysql --datadir=/data/mysql    
生成数据库并制定数据目录和用户目录  
mkdir /etc/mysql ;  
cp support-files/my-huge.cnf  /etc/mysql/my.cnf 复制配置文件  
ls support-files/  查看数据库支持模板  
\---------------------------------------  
 
vim /etc/mysql/my.cnf    
[mysqld]    
#datadir=/data/mysql  只增加这一项▲    
#socket= /data/mysql/mysql.cock  
[client]  
#socket=  /data/mysql/mysql.cock  
\-------------------------------------------  

cp support-files/mysql.server  /etc/init.d/mysqld  复制程序  
chkconfig --add mysqld 添加服务  
service mysqld start  启动服务  
echo 'PATH=/usr/local/mysql/bin:$PATH' >/etc/profile.d/mysql.sh  
添加到变量 ;    
. /etc/porile.d/mysql.sh 生效  
mysql  
>select @@datadir;   数据库路径  
>show varibles like 'datadir';  同上  
>show databases;  查询数据库  
>select @@prot  查看服务的端口  
>use mysql  
>desc user;  查询user的表结构  
>select user,host,password  from user; 查询用户密码  
  
cd /usr/local/mysql/support-files/  
mysql_secure_installation 添加安全脚本  

--语言规范  
sql标准：  
/* */ 多行注释；--  单行注释（有空格）  
mysql标准：（都支持）  
  
命名规则： 字母开头，中间建议只加下划线 _  
不要使用MySQL的保留字   
如：show status select..  
同一个database，对象不能同名  

sql语句分类：  
数据定义：create；drop 删除；alter 修改  
数据操纵：insert增；delete 删；update改  
数据控制：grant授权；revoke取消授权  
	commit确定，rollback取消确定（管理事物）  
数据查询：select 查询  



--源码编译后多实例配置  /mysql  所有实例根目录▲  
/app/mysql/bin  二进制数据库路径  
多实例：3306 3307 3308端口  
systemclt stop mariadb 先停服务 ▲  
工作目录：mkdir  /mysql/{3306.3307,3308} 数据库相应文件  
cd /data/mysql  
mkdir  -P mysql {3306.3307,3308}/{etc,log,pid,socket}  
chown -R mysql.mysql /mysql  
cd /app/mysql/scripts  生成数据库文件   
./scripts/mysql/install_db  --user=mysql --datadir=/mysql/3306  
./scripts/mysql/install_db  --user=mysql --datadir=/mysql/3307  
./scripts/mysql/install_db  --user=mysql --datadir=/mysql/3308  
安装mysq文件  
cp /etc/my.cnf   /mysql/3306/etc/  准备数据库配置文件  
vim /mysql/3306/etc/my.cnf  更改配置文件  
[mysqld]  
port=3306  
datadir;/mysql/3306/  
socket =/mysql/3306/socket/mysql.sock  
[mysqld_safe]  
log-error=/mysql/3306/log/myradb.log  
pid-file=/mysql/3306/pid/mariadb.pid  
cp /mysql/3306/etc/my.cnf  /mysql/{3307,3308}/etc/  
3307 3308 都复制配置文件，并修改端口  
vim my.cnf  ;    %s/3306/3307   
vim my.cnf  ;    %s/3306/3308   
rz 复制mysqld启动脚本（适用于启动数据库脚本）▲  
cp mysqld  /mysql/{3307,3308}/  复制启动脚本到数据库目录   
vim mysql/3306/mysqld 
prot=3306  
mysql_user=""  
cmd_path="/qpp/mysql/bin" 
mysql_basedir="/mysql"  
3307,3308再依次修改mysqld脚本端口并且加执行权限即可   
ss -ntl 查看3306端口，是否关闭  
./mysql/{3306,3307,3308}/mysqld start 分别启动服务脚本并验证端口▲  
mysql -uroot -p -s  /mysql/3308/socket/mysql.sock 通过端口登录  
或 mysql -uroot -h127.0.0.1 -P 3308  通过tcp/ip登录  
/mysql/3308/mysqld stop 停止服务（脚本要加centos口令）  
/mysql/3308/mysqld start 启动服务  
select user,password,host from mysql.user;  
查看该表口令  
mysql_secure_installtion  更改口令（默认是修改源码编译的mysql）  
cd /mysql/3308/   
mysql_secure_installtion -S /mysql/3308/sock/mysql.sock 改3308口令  
mysql -uroot -h127.0.0.1 -P 3308 -pcentos （口令centos）  
 登录验证！！  
把启动脚本分别复制到 /etc/init.d/mysqld3307|3308|3306  
后面可通过service mysqld3306 启动和关闭   
cd /mysql/3308 ;   
vim mysqld ; 添加 chkconfig:345(模式)  80(启动顺序)  2(关闭顺序)  
chkconfig --add  mysqld3308 添加到开机启动  
\---------------------------------------  
让配置文件不显示到数据库文件列表↓↓↓    
cd /mysql/3307  
./mysqld stop 停服务  
mv mysqld  etc/  /mnt ▲ （只保留这两，其余删除，通过安装再生成↓）   
./scripts/mysql_install_dab --user=mysql  --/mysql/3307/data   
vim /3307/my.cnf 修改配置文件的路径端口等信息  
mv /mnt/etc/  mnt/mysqld  mysql/3307/  
mysql -uroot -h127.0.0.1 -P 3307  或↓  
mysql_secure_installtion -S /mysql/3307/sock/mysql.sock  
  
\--------------------------------------------  
--数据变型  
tinyint:1字节  smallint:2字节  mediumint:3字节 int:4字节 bigint:8字节  
unsigned：整数 float：浮点数  decimal：定点数   text文本  
M精度 D标度(小数位)  例：float（3,2） 123.45   
char：定长4字节(不够填充0)  varchar：变长(字符+1)  

--修饰符  
NULL 空值 ； NOT NULL 非空值 ；DEFAULT 默认值   
PRIMATY KEY 主键；UNIQUE KEY 唯一值 ；  
CHARACTER SET name   指定字符集  
AUTO_INCREMENT 自动递增（整数）   
UNSIGNED 无符号  ENUM枚举 例：enum（'m','f'）  

--数据库操作  推荐：utf8mb4 字符集 (34.17)  
>show databases;  查看数据库列表  
>create database testdb; 增  
>drop database testdb;   删  
>show create database testdb; 可查看testdb用的字符集  
>create database db_utf8mb4 CHARACTER SET=utf8mb4;   
>show charecter set; 查看系统支持字符集  
>show collation; 查看排序规则  

--创建表  
>create database studentdb;创建数据库  
>use studentdb; 切换到该数据库  
>create table student (id int unsigned auto_increment primary   

key,name varchar(10) not null,sex enum('m','f') default 'm',age  

tinyint unsigned,mobile char(11),address varchar(50)); 创建表   
>desc student; 显示该表结构   
>show columns from student; 同上  
>show create table student; 查看该表类型，字符集类型  
>show create database studentdb; 显示数据库信息  
>drop table student; 删除表  
>show table status like 'student'\G; 查看表属性（换行显示）  
>show table status from mysql\G;  显示某个库所有表（换行显示）  

--表操作  
>show indexes from student\G;  查看索引  
>select count(*) from student;  当前表记录数  
>insert into(可不写) student (name,age,mobile,address) values   

('mage',30,10086,'beijing') ..  
('zhangsir'28,10010,'zhenzhou') 创建两条记录  
>select * from student; 查看当前表所有内容  
>create table employee select * from student;  
创建employee，克隆student表及数据  
>create table custom like student; 复制student结构，不复制数据  
>insert student set name='wang',age=18,address='beijing';  
对student表插入记录赋值1  
insert student (age,name,mobile,address) values   

(20,'zhao',null,'shanghai');  
对student表插入记录赋值2  
>insert custom select * from student;   
插入custom，选择student表数据(表结构应该一致)  
cd   
>use db_utf8mb4  
>create table student like studentdb.student;   
复制studentdb数据库的表结构  
>desc student 查看当前表结构  
>show create table student; 显示指定表  
>show tables; 显示当前库所有表  
>alter table student CHARACTER SET = utf8mb4; 更改表字符集  
>show create table student; 查看表    
>insert student (name,age,address) values('杜甫',22,'杭州');  
>status 查看（客户端编码不一致，导致汉字无法显示）  
>insert student select * from studentdb.student;  
>select * from student;  
  
创建表并且，修改字符集utf8mb4    
 CREATE TABLE \`t2` (   

\`id` int(10) unsigned NOT NULL DEFAULT '0',   

\`name` varchar(10)  NOT NULL,    

\`sex` enum('m','f')  DEFAULT 'm',  

\`age` tinyint(3) unsigned DEFAULT NULL,  

\`mobile` char(11)  DEFAULT NULL,  

\`address` varchar(50)  DEFAULT NULL  

) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4     

>use db_utf8mb4     
>create table student like studentdb.student; 创建新表继承上表属性  
>alter table student 修改student表  
>insert student (name.age.address) values ('杜甫',22,'杭州')；  
>delete from student where id >=5; 删除大于等于5的记录  
>truncate table student; 清空表，不记录日志  
>update student set name='bbb' where id=5; 修改id为5的记录  
#mysql -U  不加where不让删除(updata和delete category触发使用)  
[safe-updates 加到mysql客户端文件也可生效]  
#mysql --help 查看帮助   
  
5.5数据库：xx.frm(表定义)  ibdata1 (数据)  
10.2数据库：xx.frm   xx.ibd    
vim/etc/my.cnf （5.5老版本）  
innodb_file_per_table  数据会单独存放▲  

vim /etc/my.cnf  
character-set-server=utf8mb4  更改字符集到配置文件▲  
vim /etc/my.cnf.d/mysql-clients.cnf  
default-character-set=utf8mb4 更改字符集到客户端配置文件▲  
字符集  

--表格处理和查找  
>use studentdb  
>select * from student  
>select * from student where age>=25 and age <=28;   
>show table status like 'student'\G; 显示表属性  
>show create table t2; 查询表结构  
>create table t1(id int,name char(3))  创建表  
>show create table t1;  查看表  
>desc t1; 查看t1表结构  
>insert t1 values(1,'王'); 插入数值  
>select * from t1; 查看t1表数据  
-------
--delete (删除数据，不删除表结构)  
>delete * from student; 删除student表，记录日志  
>truncate table student; 清除表，不记录日志  
>insert t2  (name,age,address) values ('马哥',22,'北京'); 删除记录  
>delete from student where id >= 5 ; 删除id大于等于5的记录  
>select * from student;    
>select id,name,age from student; 显示student的id，name，age字段   
>select name as 姓名 ,id,age from student; 显示name为姓名（别名）  
>select * from student where age > 25; 年龄大于25  
>select * from student where age >= 25 and age <=28; 大于或小于  
> select * from student where age between 25 and 28;  25-28之间  
>select * from student where age in (20,30,40);  查找20,30,40  
>   查找空数值  
>select * from student where mobile is not null；查找非空数值  
>select * from student where name where name like '%a%';  
包含a的字符 ； a% ：a开头的数值  .....  
>select * from student where name rlike '^a'; 正则表达式，a开头数值  
  （模糊匹配尽可能不用，影响服务器性能）  
>insert student (name,sex,age) values ('xieshanshan','xx',20);  
>update student set sex='f' where id=5; 添加性别  
>select distinct sex from student; 显示不同的性别（参数）  

--SELECET  
<=> 相等或为空； <> 不等于 not null ; and并且 ; or与或 ; xor异或  
group 把查询结果分组用于聚合运算 group by  
avg();max();min();count(),sum()  
having:对分组聚合运算后的结果指定过滤条件  
order by：根据指定的字段对查询结果排序；asc升序；desc；降序  
limit：对输出结果行数进行数量限制  
for update：写锁，只有一个读和写  
lock in share mode：读锁，共享锁，同时多个读   

rz hellodb_innodb.sql添加数据库  
mysql < hellodb_innodb.sql 导入数据库  
>use hellodb  
>show create database hellodb;  
>show tables;  
>select count(*) from student; 统计有多少条记录  
>select gender as 性别,count(*) as 人数 from student group by   
  
gender ； 按性别区分，统计人数总数  
>select gender,avg(age) from students group by gender;   
按性别区分，统计平均年龄  
>select classid,gender,max(age) from students group by   

classid,gender;  
选择3个组，根据班级和性别，分组统计最大年龄[classid gender max]  
>select gender,avg(age) from students group by gender having   
  
gender='m';  
选择2个组，先根据性别分组，再过滤男生，计算平均年龄  
>select gender,avg(age) from students where gender='m' group by 
gender;   
选择2个组，先过滤男生，再分组，计算平均年龄  
group by  (分组)+having▲   
where + gender (过滤) ▲  
>select classid,count(*) from students where classid no null  group by classid;  
选择1个组，先过滤chlassid不为空的，根据classid计算人员总数  
>select classid,count(*) from students where classid no null group   

by classid having classid >=3;  
选择1个组，先过滤chlassid不为空的，根据classid计算人员总数，再删选
classid>=3的班级  
>select *from students order by age desc;  根据age从倒叙排序  
>select *from students order by age asc;  根据age默认排序  
>select *from students order by age asc limit 3,4; 跳过前3个，取后4个    
>select * from students order by classid ,age desc;   
先班级id排序，然后年龄倒叙排序   
>select * from students order by -classid desc; 年龄排序；NULL排最后  
>select * from students order by age asc; 根据年龄排序_不加asc也行  
>select * from students order by age desc;根据年龄倒序排  
>select * from students order by age asc limit 3; 取前三个  
>select * from students order by age asc limit 3，4; 跳过前3，取后4个  
>select * from students order by -classid , age desc;  
先对classid排序（其中null值排最后），再对age倒序排序  
>select stuid as 编号,name as 姓名,age as 年龄 from students;  
先分别对stuid，name，age编号子啊取值  


--练习  
导入hellodb.sql生成数据库  
(1) 在students表中，查询年龄大于25岁，且为男性的同学的名字和年龄  
select name,age from students where  gender = 'm' and age >25 ;  
  
(2) 以ClassID为分组依据，显示每组的平均年龄  
select classid,avg(age) from students group by classid having avg
(age);  

(3) 显示第2题中平均年龄大于30的分组及平均年龄  
select classid,avg(age) from students group by classid having avg
(age) > 30;  
  
(4) 显示以L开头的名字的同学的信息  
select  * from studens where name like 'L%' ;   
  
(5) 显示TeacherID非空的同学的相关信息  
select * from students where teacherid is not null;  
  
(6) 以年龄排序后，显示年龄最大的前10位同学的信息  
select * from students group by age desc limit 10;  
  
(7) 查询年龄大于等于20岁，小于等于25岁的同学的信息  
select * from students where age between 20 and 25;  

【多表操作】  
--union 纵向合并  
>select stuid,name,age,gender from students  
->union  
->select * from teachers;  
选择四个字段，students和teachers表纵向合并  
  
>select * from t2 unino select * from t2 unino  自己跟自己合并去重  
>select distinct * from t2; 去重标准写法  

--cross join  横向合并（字段合并，也叫交叉连接）  
>select * from students cross join teachers;  
(字段叠加，左边每条记录分别和右边每条记录依次合并，但意义不大)  


内连接_常用，左外链接，右外连接，合并去重，合并去掉重复，自连接  
--内连接【A|B 取交集】  
>select * from students,teachers where 
students.teacherid=teachers.tid;  
-----《两条命令显示结果一样↑↓》  
>select * from students inner join teachers on   
  
students.teacherid=teachers.tid;  
students和teachers表合并，取交集  

>update students set teacherid=1 where stuid=25;  
更新students表中teacherid=1的记录，使其studi=25  
  
>select stuid,s.name as student_name,tid,t.name teacher_name   

from students as s inner join teachers t on s.teacherid=t.tid;  
student表和teachers分别取别名s和t，并且合并表取交集  
（交互操作取别名后，不能再引用原始名称）▲▲▲▲  

--外连接 【A全部都要，B只取相同条件的记录，合成完整记录】  
 >select * from students as s left outer join teachers  t on 
s.teacherid=t.tid;  左外连接  
显示students.teacherid全部，并取teachers.tid与之相同的记录  

 >select * from students as s right outer join teachers  t on s.teacherid=t.tid;  右外连接  
显示teacherid.tid全部，并取students.teacherid与之相同的记录  

--左外链接+去掉交集  
 >select * from students as s left outer join teachers  t on 
s.teacherid=t.tid where t.tid is null;  
--右外链接+去掉交集  
 >select * from students as s left outer join teachers  t on 
s.teacherid=t.tid where s.teacherid is  null;  
  
--子查询（查询语句里面嵌入另外的语句）  
>select * from teachers where age>(select avg(age) from students);  
显示大于平均年龄的记录  
  
--完全外连接（合并去重） mysql数据库不支持▲  
#select * from students full outer join teachers on   
  
students.teacherid=teachers.tid;  
>select * from students as s left outer join teachers  t on 
s.teacherid=t.tid 左外链接  
->union 列合并  
->select * from students as s right outer join teachers  t on 
s.teacherid=t.tid; 右外连接  

--完全外连接（去掉交集）  
select * from  (select stuid,s.name as student_name,s.age as 
student_age,s.gender as student_gender ,classid,teacherid,tid,t.name   
as teacher_name,t.age as teacher_age,t.gender as teacher_gedner 
from students as s  left outer join teachers t on  s.teacherid=t.tid      
union    
select stuid,s.name,s.age,s.gender,classid,teacherid,tid,t.name,t.age,t.gender from students as s right outer join teachers  t on  s.teacherid=t.tid)   
as f  where f.teacherid is null or f.tid is null;  
  
--练习_显示姓名+领导名称  
>create table hellodb.emp (id int,name char(3),leaderid int);  
>use hellodb  
>insert emp value(1,'马永亮',null);  
>insert emp value(2,'张冠宇',1);  
>show warnings; 可显示故障信息  
> insert emp value(3,'wan',2),(4,'yan',3);  
>select a.name,b.name from emp as a left outer join emp as b on 
a.leaderid=b.id;  
单张表左外连接+取交集（as可不加，outer可不加）  
  
use hellodb ; courses/scores/students   
学生姓名，考试科目，考试成绩  
select st.name,sc.courseid,sc.score from students as st inner join scores as sc on st.stuid=sc.id;  
根据students和scores表，取id交集并显示姓名/科目id/成绩  
select st.name,co.course,sc.score from students as st inner join 
scores as sc on st.stuid=sc.id inner join courses as co on 
sc.courseid=co.courseid;  
根据students和scores表和courses表，取id交集，并显示姓名/科目/成绩  
	

--视图   view  
特性：VIEW,虚表；保存实表的查询结果；  
	视图本身不存数据；  
	只保留表结构,可隐藏表真实情况，敏感数据；  
	对视图操作实际是对表操作；  
>use hellodb  
>create view v_students as select stuid,name,age from students;  
 生成视图,取students表的stuid，name，age字段  
>show table status like 'v_students'\G  查看视图/表状态  
>show create view v_students\G 显示表定义  
>desc v_students;  查看视图结构  
>select * from v_students; 查看视图（已隐藏表结构信息）  
>insert v_students values(26,'wang'.30); 可对视图添加记录  
>create view v_old_sutdents as select stuid,name,age from   students   

where age >50;   创建视图，添加50以上的记录  
>select * from v_old_students;   
>insert v_old_students values(27,'li',20)  
插入记录，但视图只显示50以上记录，实际信息添加在表里
>select count(stuid) from students; 统计行记录，null值不算在内

--函数 function（系统内置函数@@  自定义函数 UDF）  
函数不能独立使用，必须嵌入到sql语句  
跨数据库调用函数，要指定数据库名  
具体要传递参数==实参  
定义函数用的参数名==形参  
>create function simpleFun() returns varchar(20) return "hello";  
创建无参数定义的函数  
>select simpleFun(); 显示函数  
>show function status\G  查看函数列表  
>show create function simpleFun 查看函数定义  
>drop function simplefun; 删除函数  

>SELECT function_name(parameter_value,...)  定义语法  
>DELIMITER // （把//作为执行命令的语句）  
***...  
>END //  
>DELIMITER ; 重新设为；为结束符  
局部变量（内部），当前命令有效  BEGIN....END，调用完就结束  
会话变量  ；>select @a  会话有效，退出，换窗口无效  
 >set a=10 局部变量    
 >set @a=10 会话变量    


--存储过程  procedure  
存储过程保存在mysql.proc表中  
可作为独立命令直接执行  
例：delimiter //  
CREATE PROCEDURE showTime()  
BEGIN  
SELECT now();  
END//  
call showtime;  执行结果显示系统时间  
show procedure status\G 显示列表状态  
show create procedure showtime\G 显示定义的函数  

例：delimiter //  
create procedure selectbyid(in uid smallint unsigned)  
begin  
select * from students where stuid = uid ;  
end//  
delimiter ;  
call selectbyid (20);  
concat ('wang',1),i )：把字符根数字关联 例；wang1 1；wang2 2..  

show create procedure name  

触发器  tigger  
BEFORE | AFTER  事件前触发，事件前后触发，基于表  
例：  
create  
[definer = { user | current_user }]  指定那个用户执行  
trigger tigger_name   指定触发器名称  
tigger_time trigger_event 指定触发的动作  
on tbl_name for each row   该触发器作用的表名 及 触发行  
trigger_body  
show triggers\G 查看触发器  
drop trigger grigger_name; 删除触发器  

--用户和权限管理 identified  
>create user test@'192.168.34.%' identified by 'centos';  
创建用户，只允许在192.168.34网段登录test（只能连，做不了操作）  
6>mysql -utest -pcents -h192.168.34.7    
远程登录34.7数据库  
>select user();  显示创建的用户  
>drop user ''@'localhost'; 删除匿名用户账户 
>rename old_user_name to new_uer_name 改名  

>flush privileges; 刷新权限才生效↑↑↑  
#mysqlsdmin -u root -poldpass password 'nwepass'  命令行变更口令  
6>mysql -utest -pcentos -h192.168.34.7  登录测试  
>select user,host,password from user; 查看当前数据库用户use mysql  

> create user root@'192.168.34.%' identified by 'centos';  
创建用户及口令（普通用户，权限小）  
>update mysql.user password=password('password ') where   
user='root'; 变更mysql数据库所有root用户的口令  
>flush privileges; 生效账户  
>select user;host,password from user; 查看账户信息  
vim /etc/my.cnf 
[mysqld]  
skip-grant-tables  忽略授权表（可免密登录）  
重启服务生效  
>update mysql.user set password=password('magedu') where   

user='root';  然后再重新更变口令  
注释配置文件#skip-grant-tables ; 重启服务，再登录   
    
--用户和权限grant管理类  
--程序类 function，procedure，trigger  
--库和表级别：databse，table  
alter；create；create；drop；index；show view； grant 授权；  
 grant otion（转赠权限）；  
>grant all on hellodb.*  to test@'192.168.34.%' ;  
授权helloddb的所有表的test用户所有权限    
>show grants fro test2@'192.168.34.%'\G 查看授权    
>grant select (name,age) on hellodb.students to test2@'192.16.34.
%' identified by 'centos';    
授权test@192.168.34%用户对students表的name，age字段查询权限  
>grant all on *.* to test3@'192.168.34.%' indentified by 'centos'  
 授权test3管理员权限  
>revoke select on *.* from test3@'192.168.34.%';  
取消用户查询授权  
>show grants for test3@'192.168.34.%'\G 查看当前用户权限  
>show grants fro current_user() ; 查看当前用户权限  
>flush privileges 重读进程生效权限  

--存储引擎对比▲  
myisam : innodb  
存储限制 256TB ：64TB  
事物        no： yes  （事物回滚没有执行成功的命令）  
locking granularity  table表 ： row行  （锁定颗粒度）  
MVCC时间戳  no  ： yes（多版本并发控制机）   
data caches  no : yes  
index caches yes : no  
foreign key support no : yes  （外键）  
事物编号，创建/更改后的时间戳  
能看到的记录：删除或创建的时间小于或者等于当前时间，才能看到  
类似快照，记录时间之前的事物都能被发现。 myisam不支持  

myisam存储引擎  
只读（或者写较少）、表较小（可以接受长时间进行修复操作）  
tbl_name.frm 表格式定义  
tbl_name.MYD 数据文件  
tbl_name.MYI 索引文件  

innodb存储引擎  
tbl_name.frm  表格式定义  
tbl_name.ibd 索引+数据	ibdata1  

[mysqld] 单独使用一个数据和索引  
inodb_file_per_table=ON   

show engines; 查看目前支持的存储引擎  
show variables like '%storage_engine';  查看默认存储引擎  
default-storage-engine=innodb 配置默认存储引擎▲新版本默认不用加  
show table status like 'tb_name' 查看指定表的存储引擎  
show create table tb_name;   查看指定表的存储引擎   
create table tb_name(..) engine=innodb;  设置表的存储引擎  
alter table tb-name engine=innodb;  设置表的存储引擎  

--mysql系统数据库  
mysql ：   
是mysql的核心数据库，类似于Sql Server中的master库，主要
负责存储数据库的用户、权限设置、关键字等mysql自己需要使用的控制和管理信息  
performance_schema数据库：  
MySQL 5.5开始新增的数据库，主要用于收集数据库服务器性能参数,库里
表的存储引擎均为PERFORMANCE_SCHEMA，用户不能创建存储引擎为
PERFORMANCE_SCHEMA的表  
information_schema数据库：   
MySQL 5.0之后产生的，一个虚拟数据库，物理上并不存在  
information_schema数据库类似与“数据字典”，提供了访问数据库元数
据的方式，即数据的数据。比如数据库名或表名，列类型，访问权限（更
加细化的访问方式）  
  
--服务器配置    
三大类 ↓↓↓    
mysqld选项    
服务器系统变量    

mysqld选项：能写到配置文件,能永久保存，不可通过show命令查看  
（支持下划线和横线）  
--xx xx 服务器选项  xx_xx_xx 变量 （变量一般都是下划线）  
>show variables like  'innodb_file_per_table' 变量可以查;  
>show variables like '%character%' ；查看带该关键字的变量  
/var/libexec/mysqld --help -v 列出服务器选项	  
/usr/libexec/mysqld -print--default 列出目前带的服务器选项  

显示全局变量mysql >show global varibles;  
显示会话变量mysql >shhow session varibles;  
系统变量：mysql >delect @@variables;   
 （@@系统自带变量； @ 自定义变量 )  

修改全局变量：SET global  system_var_name=value;  
修改会话变量：SET [session]  system_var_name=value;  
例：  
set variables character_set_server=utf8mb4 修改字符集变量_会话级  
set global character_set_server=utf8mb4; 修改字符集变量_全局  
show variables like '%character%'; 查看变量  
show global variables like  '%character%'; 查看全局变量（重登生效）  
set character_set_results=utf8mb4; 也可以查看设置  

--服务器变量查询：  
https://mariadb.com/kb/en/library/server-system-variables/  
[commandline]表示服务器选项  
[scope]globa 表示即是变量又是选项  

--服务器变量  
>set sql_mode='traditional'  字段值超长将不记录  
>use hellodb  
>show status like 'com_select';  
显示com_select   2  记录查询的次数  
set com_lelect=  3 状态变量不可更改！  

> show variables like 'max_con%';  显示并发连接数  
>set global max_connections=2000  更改并发连接数  
>show variable max_connetctions  
redo重做 undo撤销    

常见MODE:  
NO_AUTO_CREATE_USER  
禁止GRANT创建密码为空的用户  
NO_ZERO_DATE  
在严格模式，不允许使用‘0000-00-00’的时间  
ONLY_FULL_GROUP_BY  
对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出  

现，那么将认为这个SQL是不合法的  
NO_BACKSLASH_ESCAPES  
反斜杠“\”作为普通字符而非转义字符  
PIPES_AS_CONCAT  
将"||"视为连接操作符而非“或运算符”  

--mysql架构  
连接器  
↓↓↓  
连接限制--sql语句语法检查--指令解析二进制--优化(索引)--缓存  
↓↓↓  
通过存储引擎访问  
↓↓↓  
文件系统  
↓↓↓  
数据文件/日志文件  

--查询执行路径  
客户端（通信协议）↓↓↓  
--查看权限--查询缓存--查执行引擎--返回结果                      
--查看权限--查询缓存--解析成二进制--优化处理--查执行引擎--返回结果  

--查询缓存（query cache）  
读得多，写得少，适合利用缓存  
判断标准：sql 语句完全一致，区分大小写，通过hash运算查询  
优缺点：提高查询效率，占用内存，调用缓存不够智能    
哪些查询可能不会被缓存：  
now() ，变量缓存，加锁内容，临时表，警报，不涉及任何表/视图的查询  
事务隔离级别为serializable，加SQL_NO_CACHE语句...  

--查询缓存  
query_cache_type：是否开启缓存功能 (ON|OFF|demand or 2按需)  
query_cache_size：缓存可用空间，最小值40k，字节为单位  
query_cache_min_res_unit： 缓存块最小分配单位，默认4k  
（↑↑调整可减少碎片化，或直接flush query cache情况缓存）   
query_cache_min_res_limit：单个查询结果能缓存的最大值，默认1M  
query_cache_wlock_invalidate  
如果某表被其它的会话锁定，是否仍然可以从查询缓存中返回结果，默认
值为OFF，ON表示不允许  
例：  
>set global query_cache_size=1024000; (1M) 写入文件可用M  
>show status like 'qcache%'; 查询相关状态变量  

查询缓存相关的状态变量：SHOW GLOBAL STATUS LIKE 'Qcache%';  
Qcache_free_blocks：处于空闲状态 Query Cache中内存 Block 数  
Qcache_total_blocks：Query Cache 中总Block ，当  
Qcache_free_blocks相对此值较大时，可能用内存碎片，执行FLUSH   
  
QUERY CACHE清理碎片  
Qcache_free_memory：处于空闲状态的 Query Cache 内存总量  
Qcache_hits：Query Cache 命中次数  
Qcache_inserts：向 Query Cache 中插入新的 Query Cache 的次数，即
没有命中的次数  
Qcache_lowmem_prunes：记录因为内存不足而被移除出查询缓存的查询数  
Qcache_not_cached：没有被 Cache 的 SQL 数，包括无法被 Cache 的 
SQL 以及由于 query_cache_type 设置的不会被 Cache 的 SQL语句  
Qcache_queries_in_cache：在 Query Cache 中的 SQL 数量  

--命中率和内存使用率估算   
查询缓存中内存块的最小分配单位query_cache_min_res_unit ：  

(query_cache_size - Qcache_free_memory) / 
Qcache_queries_in_cache  
查询缓存命中率 ：Qcache_hits / ( Qcache_hits + Qcache_inserts ) * 
100%  
查询缓存内存使用率：(query_cache_size – qcache_free_memory) / 
query_cache_size * 100%  
   
--索引 explain  
适用于数据量大，读的数据比较多  
B数（二叉树）： 节点和叶子节点都有数据  
	一个节点两个分叉，存在不平衡问题  
红黑树：每个节点有两个分叉，平衡的二叉树  
B-TREE：多叉数，平衡树，节点包括叶子都包含索引+数据  
	每次都要跑根节点查询，树层级太多，效率不高  
B+TREE：只放数字索引，提升速度，节点和分支节点不放数据，所有数据  

存放在叶子节点，且包含指针，可不通过根直接查找，主流通用  

hash索引 ：只合适精确查找，不支持模匹配和范围查询  I/M 不支持  
空间数据索引   多维度综合查询，常用作地理数据储存 5.7以后支持  
全文索引 查找文本关键词，而不比较索引的值，类似搜索引擎 5.6以后  

索引优点：  
索引可以降低服务需要扫描的数据量，减少了IO次数  
索引可以帮助服务器避免排序和使用临时表  
索引可以帮助将随机I/O转为顺序I/O  
索引缺点：  
占用额外空间，影响插入速度  

聚簇索引和非聚簇索引，主键和二级索引   
聚簇索引：索引和数据一起存放  
非聚簇索引：索引和数据分开存放  
主键索引：主键和数据放在一起  
二级索引：索引和数据分开放  
（查两次，如先查选项索引，再查主键索引定位数据位置）  
稠密索引：每个索引都有对应的多个数据项  
稀松索引：每个索引对应一个数据  
简单索引：对一个字段创建索引  
组合索引：针对多个字段创建索引  

--B+tree索引  
顺序存储，每一个叶子节点到根结点的距离是相同的；左前缀索引，适合查询范围类的数据    
可以使用B+Tree索引的查询类型：  
全值匹配；匹配最左前缀；匹配列前缀；匹配范围值  
精确匹配某一列并范围匹配另一列；只访问索引的查询    
  
--管理索引  
explain 分析索引的有效性，复合索引，先用前字段做排序，所以只能用左
边字段做索引，若匹配到多项记录，无法利用索引  
query_cache_size=10M 导入配置文件  
>create index idx_name on test(name(10))  
创建idx_name索引到test,使用name字段的前10个  
>show indexes from testlog\G 查看此表的索引信息  
>select * from test log where id=9999 ; 指定索引第几行  
>show variables like 'query_cache%'; 查看缓存相关变量  
>explain select * from testlog where id=1999; 分析索引使用情况  
>explain select * from students where name='X%' and age=30;也行  
>drop index idx_name on testlog; 删除inx_name索引  

查看索引的使用情况  
SET GLOBAL userstat=1; 更改变量（可加入配置文件）  
>show variables like 'userstat'; 查看变量  
>show index_statistics; 查看索引使用情况  
>create unique index uni_name on students(name);   
创建唯一键索引，引用的字段数据不能有重复  


--并发控制  
锁粒度：表级锁，行级锁   
锁：读锁 共享，只读不可写，多个读互不阻塞，只适合myisam  
       写锁 独占锁，排它锁，一个写锁会阻塞其它读和它锁  
实现  
存储引擎：自行实现其锁策略和锁粒度  
服务器级：实现了锁，表级锁；用户可显式请求  
分类（隐士锁:有存储引擎自动施加锁，显示锁：手动）  

>lock tables students read;  加读锁  
>lock tables students write;  加写锁，独占锁，仅自己可读可看  
>update students set classid=1 where stuid=20; 加锁会无法修改  
>unlock tables； 是用该命令或退出会话也会解锁  
>flush tables with read lock 所有数据库加读锁,也不能创建用户/表  
>flush tables xx(可加表) with read lock   
关闭正在打开的表（清除查询缓存），通常在备份前加全局读锁  
>grant all on hellodb.* to test@'%' identified by 'centos' ；加用户  

--事务（一组原子性的SQL语句，或一个独立工作单元）  
myisam 没事务日志  
事务日志：记录事务信息，实现undo,redo等故障恢复功能   
ACID特性：  
A：atomicity原子性；整个事务中的所有操作要么全部成功执行，要么全
部失败后回滚  
C：consistency一致性；数据库总是从一个一致性状态转换为另一个一致
性状态  
I：Isolation隔离性；一个事务所做出的操作在提交之前，是不能为其它事
务所见；隔离有多种隔离级别，实现并发  
D：durability持久性；一旦事务提交，其所做的修改会永久保存于数据库
中  
异常挂关闭的事务(未执行完)，重启服务后回滚撤销---日志   
已完成的事务 redo  异常关闭；重复执行  
未完成的事务 undo  异常关闭；回滚撤销  

启动事务：（可不用配置autocommit）批量提交速度更快  
BEGIN  
BEGIN WORK  
START TRANSACTION  
结束事务：  
COMMIT：提交  
ROLLBACK: 回滚撤销  
(只有事务型存储引擎中的DML语句方能支持此类操作)  
自动提交：set autocommit={1|0} 默认为1，为0时设为非自动提交  
（mysql默认1条命令为一个事务）  
事务支持保存点：savepoint  执行多个命令，只撤销一部分  
SAVEPOINT identifier  
ROLLBACK [WORK] TO [SAVEPOINT] identifier  
RELEASE SAVEPOINT identifier  
例：  
>begin  
>insert students (name) values (a);  
>savepoint sp_a;  
>insert students (name) values (b);  
>savepoint sp_b;  
>insert students (name) values (c);  
>rollback to so_b 只撤销到b的保存点，a和b记录还在  
>release savepoint sp_a; 释放保存点  

select @@autocommit; 查看该变量    
autocommit=0  可写入配置文件  
>show processlisk\G 查看进程列表  
>kill 4(ID);   删除ID为4的编号，可实现解锁  
>select @@autocommit;    
>commit; 提交，前提是autocommit已修改或加begin情况下使用  
>rollback;  回滚撤销  

>truncate table coc ; 清空表  
>drop table scores; 删除表  
（以上两条命令需要创建表结构才能撤销还原）▲  

事务隔离级别：从上至下更加严格  
READ UNCOMMITTED 可读取到未提交数据，产生脏读  
READ COMMITTED 可读取到提交数据，但未提交数据不可读，产生不可
重复读，即可读取到多个提交数据，导致每次读取数据不一致  
REPEATABLE READ 可重复读，多次读取数据都一致，产生幻读，即读取
过程中，即使有其它提交的事务修改数据，仍只能读取到未修改前的旧数
据。退出会话或执行commit;，可看到更新后的事务，此为MySQL默认设置▲  
SERIALIZABILE 可串行化，未提交的读事务阻塞修改事务，或者未提交的
修改事务阻塞读事务。导致并发性能差     
MVCC: 多版本并发控制，和事务级别相关(只对中间2项隔离级别有效)    
发生死锁，只保留执行时间长的事务（根据时间维度判断）    

SET tx_isolation=    
配置文件【transaction_isolation=...】    
READ-UNCOMMITTED  可未提交数据    
READ-COMMITTED  可读提交数据    
REPEATABLE-READ   可重复读    
SERIALIZABLE    可串行化    

show variables like 'tx_isolation';查看隔离级别  
vim /etc/my.cnf f 设置隔离级别 (变量选项不同名▲)  
transaction_isolation=read-uncommitted 修改成可读未提交数据  

--并发控制  
死锁：  
两个或多个事务在同一资源相互占用，并请求锁定对方占用的资源的状态  
事务日志：  
额外的IO，顺序操作，性能会受影响  
事务日志文件： ib_logfile0， ib_logfile1 （写满轮流覆盖）  
可增加事务日志及大小，等系统空闲时间，再从事务日志写入数据库  


--通用日志（排除故障，性能优化，一般不启用）  
>show variables like '%innodb_log%'; 显示事务日志相关配置  
innodb_log_file_size=5242880 每个日志文件大小  
innodb_log_files_in_group=2 日志组成员个数  
innodb_log_group_home_dir=/./  事务文件路径  
innodb_flush_log_at_trx_commit 默认为1 (性能相关)  
设置为1，同时sync_binlog = 1表示最高级别的容错  
1事务提交一次写一次  
0每秒写缓存，执行一次（秒为单位）  
2每次事务提交写缓存，但每秒都会进行一次刷新（事务单位）  
3模拟MariaDB 5.5组提交（每组提交3个同步），此项MariaDB 10.0支持  

--错误日志（只读）  
启动和关闭过程输出的事件信息，运行中产生的错误信息  
event scheduler运行一个event时产生的日志信息（事件调度器）  
从服务器启动时产生的信息   
日志相关配置：    
show global variables like 'log_error'  
错误文件路径  
log_error=/PATH/TO/LOG_ERROR_FILE  
是否记录警告信息至错误日志文件  
log_warnings=1|0 默认值1  

--通用日志(默认不启用，有性能负担，排除/性能优化时可用到)  
tail -f  /var/log/mariabd/mariadb.log 查看日志文件路径  
>show global  variables like 'general_log'\G 显示通用日志信息  
>set general_log=ON  启用通用日志,生成centos7.log文件  
>set global log_output=table;  将日志添加到mysq库里的表  
(↑默认日志会放入文件)  
>use mysql  ↓↓↓  
>select * from general_log 查看日志表  
>select count(argument) from genneral_log;   
在genneral_log表里统计argument数量  
>select argument,count(*) from general_log group by argument;  
在genneral_log表里统计argument数量，每个命令重复多少次▲  
可分析当前数据库哪些命令用的多，那个字段使用较频繁 

--慢查询日志（记录查询时长超出指定时长的操作，默认OFF）  
slow_query_log=ON|OFF 开启或关闭慢查询  
long_query_time=3  慢条件阈值，超过3秒记录到日志，建议开启▲  
slow_query_log   配置慢查询到配置文件  
会生成centos7-slow.log日志文件  

>select @@long_query_time 查看变量值  
>select sleep(1) from teachers;  查每条记录睡1秒  
log_queries_not_using_indexes=ON 不使用索引或使用全表扫描，不论
是否达到慢查询阀值的语句是否记录日志，默认OFF，即不记录，建议开
启▲  
log_slow_rate_limit = 1 多少次查询才记录，mariadb特有  
>show index from students\G  查看索引  
>drop index idx_age_name on students; 删除多余索引  
>create index idx_age on students(age);  添加索引  

慢查询分析：  
>select @@profiling; 查看变量，默认不启用0  
>set profiling=ON;  启用(会话级)  建议启用▲  
>show profiles; 查看profiling功能启用期间执行的命令列表及编号  
>show profile for query 5;  查看当前项(编号)的详细说明  
（列出每一步执行所花费的时间，可用来分析）  

--二进制日志▲重点 （用于恢复数据，也称为归档日志，默认不启用）  
后于事务日志，记录已提交过的日志（增删改操作）  
不依赖于存储引擎类型  
功能：通过“重放”日志文件中的事件来生成数据副本  
注意：建议二进制日志和数据文件分开存放  
中继日志：relay log  
主从复制架构中，从服务器用于保存从主服务器的二进制日志中读取的事件  
  
二进制日志记录三种格式：binlog_format▲   
基于“语句”记录：statement，记录语句，默认模式  
基于“行”记录：row，记录数据，日志量较大，推荐使用▲  
混合模式：mixed, 让系统自行判定该基于哪种方式进行  
>show variables like 'binlog_fromat';  显示日志格式  
(5.5默认是基于语句记录，10.2.19 默认mixed混合模式)  
  
二进制文件的构成：  
有两类文件  
日志文件：mysql|mariadb-bin.文件名后缀，二进制格式  
如： mariadb-bin.000001 达到一定大小自动生成新文件(离线归档日志)  
索引文件：mysql|mariadb-bin.index，文本格式  

sql_log_bin=ON|OFF：是否记录二进制日志，默认ON  
set sql_log_bin=OFF：临时禁用二进制日志，会话级，可直接生效  
log_bin=/PATH ：指定日志路径，默认OFF  
select @@sql_log_bin  +  select @@log_bin  都启用才记录二进制日志  
 
vim /etc/my.cnf    写入配置文件  
（建议单独建立二进制目录+并修改mysql所有者权限）  
[mysqld]  
log_bin=/data/logbin/mysql 二进制日志指定路径(mysql是指定前缀)  
sql_log_bin(系统默认ON，所以不用添加)  
>select @@binlog_fromat; 查看日志格式  
>select @@max_binlog_size; 日志最大存储值，处默认1G  
sync_binlog=1|0：设定是否启动二进制日志即时同步磁盘功能，默认0，  
  
由操作系统负责同步日志到磁盘  
expire_logs_days=N：二进制日志可以自动删除的天数。 默认为0，即不
自动删除  

二进制日志相关配置：  
SHOW {BINARY | MASTER} LOGS：  
查看mariadb自行管理使用中的二进制日志文件列表，及大小  
SHOW MASTER STATUS：查看使用中的二进制日志文件  
show binlog events 查看所有日志  
show binlog events in 'mysql-bin.000001' from 656 limit 2,3;  
查看二进制文件中的指定内容，跳过2个看第3个  
flush logs;  生成新的日志文件  

二进制日志的客户端命令工具mysqlbinlog  
命令格式：  
mysqlbinlog [OPTIONS] log_file…  
--start-position=# 指定开始位置
--stop-position=#
--start-datetime=
--stop-datetime=
mysqlbinlog  /data/logbin/mysql-bin.0000003 --verbose(-v)
--start-position=510 --stop-position=824;
查看指定的日志文件，从510到824之间位置之间

mysqlbinlog  /data/logbin/mysql-bin.0000003 -v  
--start-datetime='2018-12-04 00:10:35'
--stop-datetime=(如忽略该条则往后全都包括)
查看指定的值日文件，从某个时间点开始，一直到最后时间点

实验：teachers表删除并恢复
>flush logs
>delete from teachers;
>select * from teschers;
mysqlbinlog  /data/logbin/mysql-bin.0000005 -v > /root/binlog.sql  
导出日志文件，并查看，然后注释#delete from teachers该命令   
>set sql_bin_log=off; 禁用二进制日志记录    
mysql hellodb </root/binlog/sql  导入二进制日志文件  
>select * from teachers; 验证    
>set sql_log_bin=on; 启用二进制日志  
（truncate删除，需要先还原表结构才能恢复）▲  

清除指定二进制日志：  
purge binary logs to 'mysql-bin.000004'   
清除此二进制日志前面的日志，包括索引文件，↑前面的01-03已清除

例：  
PURGE BINARY LOGS TO ‘mariadb-bin.000003’;删除3之前的日志  
PURGE BINARY LOGS BEFORE '2017-01-23'; 删除1.23之前的日志  
PURGE BINARY LOGS BEFORE '2017-03-22 09:25:30'; 精确到秒↑同上  

reset master 删除所有日志文件，包括索引  
reset master # 指定从几开始记录二进制文件，默认1  
(mariaDB 10.1.6以后开始支持)   
flush logs; 切换新的日志文件  
\------------------------------  
建议必须设置的▲  
log_bin=/PATH  指定文件路径（和数据库不同目录）  
binlog_format=row 指定二进制日志格式  
max_binlog_size=10G..  单个二进制日志大小  
sync_binlog=1|0    
0：每秒写入缓存，同步磁盘  
1：每次事务完毕写入缓存，同步磁盘  
exprire_logs_days=N 二进制日志自动删除天数，默认0，不删除  
innodb_file_per_table  数据表单独存放（5.5老版本）  
character-set-server=utf8mb4 服务端字符集配置  
default-character-set=utf8mb4  客户端字符集配置   
query_cache_size=10M 查询缓存  
datadir=/var/lib/mysql   数据库路径  
\-------------------------------

--备份和恢复  
需要备份的内容：  
文件数据库  
mysql 数据库：包含用户账号，权限分配信息  
my.cnf 配置文件  
  
--备份类型：  
1）完全备份：整个数据集  
2）部分备份：只备份数据子集，如部分库或表   

--增量备份、差异备份     
增量备份：仅备份最近一次完全备份或增量备份（如果存在增量）以来变  
  
化的数据，备份较快，还原复杂  
差异备份：仅备份最近一次完全备份以来变化的数据，备份较慢，还原简
单  

--冷、温、热备份  
冷备：读写操作均不可进行 (复制文件，添加二进制日志路径，改权限)  
温备：读操作可执行；但写操作不可执行  
热备：读写操作均可执行  
MyISAM：温备，不支持热备  
InnoDB：都支持  

--物理和逻辑备份  
物理备份：直接复制数据文件进行备份，与存储引擎有关，占用较多的空
间，速度快  
逻辑备份：从数据库中“导出”数据另存而进行的备份，与存储引擎无关
，占用空间少，速度慢，可能丢失精度   
  
--备份工具  
cp, tar等复制归档工具：物理备份工具，适用所有存储引擎；只支持冷备
；    
完全和部分备份LVM的快照：先加锁，做快照后解锁，几乎热备；借助文件系统工具进行备份      
mysqldump：逻辑备份工具，适用所有存储引擎，温备；支持完全或部分备份；  对InnoDB存储引擎支持热备，结合binlog的增量备份  
xtrabackup：由Percona提供支持对InnoDB做热备(物理备份)的工具，支
持完全备份、增量备份  
MariaDB Backup： 从MariaDB 10.1.26开始集成，基于Percona 
XtraBackup 2.3.8实现  
mysqlbackup：热备份， MySQL Enterprise Edition组件  
mysqlhotcopy：PERL 语言实现，几乎冷备，仅适用于MyISAM存储引擎  
，使用LOCK TABLES、FLUSH TABLES和cp或scp来快速备份数据库  

--基于LVM的备份▲    
fdisk /dev/sda    
#t;6;8e;p;w   
partprobe  
pvcreate sda6  
vgcreate vg0 /dev/sda6  
lvcreate -n mysql -L 1G vg0  
lvcreate -n binlog -L 1G vg0   
mkdir /data/{mysql,binlog}  
systemctl stop mariadb  
mkfs.xfs /dev/vg0/mysql  
mkfs.xfs /dev/vg0/binlog  
blkid  
mount /dev/vg0/mysql /data/mysql    
mount /dev/vg0/binlog /data/binlog    
vim /etc/my.cnf 修改后  
#log_bin=/data/binlog/mysql-bin ;   
#datadir=/data/mysql    
#socket=/data/mysql/mysql.sock   
cp -av /var/lib/mysql/*  /data/mysql/  
chown -R  mysql.mysql  /data/mysql/   /data/binlog/  
vim /etc/my.cnf.d/mysql-clients.cnf  
#socket=/data/mysql/mysql.sock  
最后重启服务，登录成功，表示前期数据库准备工作已完成  
>flush tables with read lock;  加读锁  
>show binary logs; ll /data/binlog/  查看二进制日志及文件位置454  
(↓在别的终端执行以下命令，否则会解锁只读属性)  
lvcreate -n mysql_snapshot -L 200M -s -p r /dev/vg0/mysql  
给/dev/vg0/mysql数据库创建快照，并设置大小和只读属性  
>unlock tables; 解锁让数据库正常读写  
>insert students (name) values('f') value('g');  
>show binary logs; 查看二进制记录位置变化   
>mount -o nouuid,norecovery /dev/vg0/mysql_snapshot /mnt   
临时挂载快照（数据库数据）至/mnt  
tar -cvf  /root/mysql.tar  /mnt/  
umount /mnt  
lvremove /dev/vg0/mysql_snapshot  移除快照  
rm  -rf /data/mysql/*   ； systemctl stop mariadb删库，然后停止服务  
tar xvf mysql.tar -C /mnt  解开数据库文件    
mv /mnt*  /data/mysql/    
>set sql_log_bin=off; 临时禁用二进制日志    
mysqlbinlog --start-postion=mysql-bin.000001 > incr.sql  
mysqlbinlog --start-postion=mysql-bin.000002 >>incr.sql  
mysqlbinlog --start-postion=mysql-bin.000003 >>incr.sql  
...  
>source /data/binlog/incr.sql  导入增量二进制文件      
>select * from students;  查看文件是否完整        
>set sql_log_bin=on 启用二进制日志  
删除顺序     
lvremove /dev/vg0/binlog  逻辑卷    
lvremove /dev/vg0/mysql      
vgremove vg0   卷组    
pvremove /dev/sda6     物理组    
fdisk /dev/sda6  ; p;d;6;w   分区删除    

操作日志：/.mysql_history    
mariadb日志：/var/log/mariadb/mariadb.log    
系统日志：/var/log/messages     

逻辑备份工具：mysqldump, mydumper, phpMyAdmin  
基于mysql协议的链接，执行查询，把相应数据返回，重定向到新文件  
mysqldump --help --default-prints 查看默认属性  
mysqldump常见选项：  
-A，--all-databases 备份所有数据库，含create database  
-B , --databases db_name… 指定备份的数据库，包括create database  

语句  
-E, --events：备份相关的所有event scheduler(计划任务)  
-R, --routines：备份所有存储过程和自定义函数  
--triggers：备份表相关触发器，默认启用,用--skip-triggers，不备份触发
器  
--default-character-set=utf8 指定字符集  
--master-data[=#]： 此选项须启用二进制日志  
1：所备份的数据之前加一条记录为CHANGE MASTER TO语句，非注释  
  
，不指定#，默认为1 (该命令用于实现主从复制)  
2：记录为注释的CHANGE MASTER TO语句 (会记录备份时间点)  
此选项会自动关闭--lock-tables功能，自动打开-x | --lock-all-tables功能  

（除非开启--single-transaction）  

-F, --flush-logs ：备份前滚动日志，锁定表完成后，执行flush logs命令,
生成新的二进制日志文件，配合-A 或 -B 选项时，会导致刷新多次数据库
。建议在同一时刻执行转储和日志刷新，可通过和--single-transaction或
-x，--master-data 一起使用实现，此时只刷新一次日志  
--compact 去掉注释，适合调试，生产不使用  
-d, --no-data 只备份表结构  
-t, --no-create-info 只备份数据,不备份create table  
-n,--no-create-db 不备份create database，可被-A或-B覆盖  
--flush-privileges 备份mysql或相关时需要使用  
-f, --force 忽略SQL错误，继续执行  
--hex-blob 使用十六进制符号转储二进制列，当有包括BINARY，   

VARBINARY，BLOB，BIT的数据类型的列时使用，避免乱码  
-q, --quick 不缓存查询，直接输出，加快备份速度  
  
例 :  
mysqldump hellodb > hello_bak.sql (默认-e)  数据库备份  
mysql -e 'create database hello'   
mysql  < hello_bak.sql 导入指定数据库（还是原来的DB名称）  
  
mysqldump hello students >students.sql 表备份  
msql -e 'create tables students';   
mysql lh < lh123.bak.sql  导入表结构到lh数据库(表删除也可以导入)  
（缺点：数据库还需手工创建，才能导入，库结构容易错配）  
\----------------------------------------↑不建议使用  
mysql dump -B hello > hello_bak_B.sql 备份数据库及结构  
mysql -e 'drop database hello'   删库   
mysql < hello_bak.B.sql  还原数据库及结构  
  
mysqldump -B hello | gzip >hello.sql.gz  备份再压缩  
或 mysqldump -B hello | xz >hello.sql.xz   
mysql -e 'drop database hello'  删库  
xz -d hello_bak.sql.xz 解压缩  
mysql < hello_bak.sql.xz  导入恢复  
>show tables; 验证  
\------------------------------------------
mysqldump -A > all_bak.sql   备份所有数据库  
rm -rf /var/lib/mysql/*  删库并重启服务  
mysql  < all_bak.sql  导入恢复  
show procedure status\G;  查看存储过程  
 
mysqldump --master-data=1 -A > all_bak4.sql    
备份所有数据库外加记录时间点245  
mysqldump --master-data=2 -A > all_bak4.sql  主从复制+2  

mysqldump -A -F > all_bak.sql  备份并分离旧的日志文件，键新的  
mysqldump --master-data=2 -A -F compact > all_bak.sql  
去掉注释备份所有数据库  
mysqldump --master-data=2 -A -d >all_bak.sql   
只备份表结构  
mysqldump --master-data=2 -A -t >all_bak.sql    
只备份数据，可以实现备份后先修改表结构，然后再导入数据  
  
--分库备份（hello，hellodb，mysql）面试题  
for db in `mysql -e 'show databases' | grep -Ev '^(Database|  
  
information_schema|performance_schema)$' `;do mysqldump -B   
  
$db|gzip > $db\`date +%F` .sql.gz;done  
或  
mysql -e 'show databases' | grep -Ev '^(Database|  
  
information_schema|performance_schema)$' |sed -r 's/  
  
(.*)/mysqldump -B \1 |gzip > \/data\/1.sql.gz\/' | bash  
  
--分库导入(删除后)  
mysql -e 'drop database hellodb'  
gunzip hellodb.sql.gz  
mysql < hellodb.sql  
mysql -e 'show database'; 查看并验证  

MyISAM备份选项：  
支持支持温备；不支持热备，所以必须先锁定要备份的库，而后启动备份  
-x,--lock-all-tables：加全局读锁，锁定所有库的所有表，同时加--  
    
single-transaction或--lock-tables选项会关闭此选项功能  
注意：数据量大时，可能会导致长时间无法并发访问数据库  

-l,--lock-tables：对于需要备份的每个数据库，在启动备份之前分别锁定 
其所有表，默认为on,--skip-lock-tables选项可禁用,对备份MyISAM的多
个库,可能会造成数据不一致(不推荐使用，会造成每个数据库备份时间不一
致，跨表互相协作会产生问题)    
注：以上选项对InnoDB表一样生效，实现温备，但不推荐使用  
  
InnoDB备份选项： 支持热备，可用温备但不建议用  
--single-transaction（以事务方式存放）   
此选项Innodb中推荐使用，不适用MyISAM，此选项会开始备份前，先执
行START TRANSACTION指令开启事务  
此选项和--lock-tables（此选项隐含提交挂起的事务）选项是相互排斥  
备份大型表时，建议将--single-transaction选项和--quick结合一起使用  
DML：表数据的增删改  
DCL：数据库/表的增删  

InnoDB建议备份策略  
mysqldump –uroot –A –F  --single-transaction --master-data=2 --
flush-privileges  --default-character-set=utf8 --hex-blob > /PATH  
MyISAM建议备份策略  
mysqldump –uroot –A –F  –x --master-data=2 --flush-privileges --
triggers --default-character-set=utf8 --hex-blob >/PATH   
utf8mb4  
show create database hello 查看数据库字符集  
show table status from hello\G;  查看存储引擎和表的字符集  
show variables like 'character%'; 查看字符集相关变量  
  
实验：删除数据库还原至最新状态▲  
mysqldump -A --single-transaction -F --master-data=2 |gzip  
>/data/all_bak_\`date +%F`.sql.gz   备份  
rm -rf /varlib/mysql/*  删库(二进制文件需分开存放)  
iptables -A INPUT -s 192.168.34.0/24 -j REJECT  拒接用户访问    
systemctl restart mariadb 生成初始数据库	  
gzip -d all_bak_2018-12-05.sql.gz 解压备份数据库  
>set sql_log_bin=off 关闭二进制日志  
>show variables like 'sql_log_bin'; 显示二进制是否关闭状态  
>source /data/all_bak_2018-12-05.sql 导入备份数据库  
cat all_bak_2018-12-05.sql 查看备份位置  
mysqlbinlog  /data/logbin/mysql-bin.0000{07,08,09,10} > incr.sql  
导出二进制日志  
>source /data/incr.sql 导入二进制文件  
>select * rom teachers; 查看并验证数据  
>set sql_log-bin=on 开启二进制日志并且恢复iptables限制  
  

--还原误删除的表  
>mysqldump -A -F --master-date=2 --single-gransaction > 
all_bak.sql   
>select * from teachers;  
>insert teachers(name) values('111');  
>insert teachers(name) values('222');  
>drop table teachers;  
iptables -A INPUT -s 192.168.34.0/24 -j REJECT  拒接用户访问  
>set sql_log_bin=off  关闭二进制日志  
>source /data/all_bak.sql 导入备份  
cat all_bak.sql  分析二进制查看记录位置  
mysqlbinlog mysql-bin.000011 > /data/incr.sql 导出二进制日志  
vim  /data/incr.sql   
#/DROP TABLE ...  注释掉删除表的命令  
>source /data/incr.sql  导入二进制日志  
>select * from students;  验证  
>set sql_log_bin=on;   开启二进制日志以及允许用户访问  

--xtrabackup 备份工具   
特点：  
备份还原过程快速、可靠  
备份过程不会打断正在执行的事务  
能够基于压缩等功能节约磁盘空间和流量  
自动实现备份检验  
开源，免费  

yum install percona-xtrabackup 在EPEL源中  
  
xtrabackup 用法：  
备份：innobackupex [option] BACKUP-ROOT-DIR  
选项说明：https://www.percona.com/doc/percona-
xtrabackup/LATEST/genindex.html  
--backup （完全备份）  
--user：该选项表示备份账号  
--password：该选项表示备份的密码  
--host：该选项表示备份数据库的地址  
--databases：该选项接受的参数为数据库名，如果要指定多个数据库，彼
此间需要以空格隔开；如："xtra_test dba_test"，同时，在指定某数据库
时，也可以只指定其中的某张表。如："mydatabase.mytable"。该选项对
innodb引擎表无效，还是会备份所有innodb表  
--defaults-file：该选项指定从哪个文件读取MySQL配置，必须放在命令
行第一个选项位置  
--incremental：该选项表示创建一个增量备份，需要指定--
incremental-basedir  
--incremental-basedir：该选项指定为前一次全备份或增量备份的目录，
与--incremental同时使用  
--incremental-dir：该选项表示还原时增量备份的目录  
--include=name：指定表名，格式：databasename.tablename
perpare 准备（--perpare）  
--apply-log ：通过回滚未提交的事务及同步已经提交的事务至数据文件使
数据文件处于一致性状态  
--apply-log-only：阻止回滚未完成的事务  
--use-memory：和--apply-log选项一起使用，当prepare 备份时，做
crash recovery分配的内存大小，单位字节，也可1MB,1M,1G,1GB等，推
荐1G  
--export：表示开启可导出单独的表之后再导入其他Mysql中  
--redo-only：合并增量备份，但不对最后一个增量备份合并  

--xtrabackup完全备份及还原▲  
1 在原主机做完全备份到/backups  
xtrabackup --backup --target-dir=/data/backups/    
完全备份到backups目录,必须先开启mysql服务  
（连接到数据库，加读锁，复制ibd数据库文件）  
scp -r /data/backups/* 目标主机:/data/backups    
（复制备份数据到目标主机的目录）  
2 在目标主机上  
1）预准备：确保数据一致，提交完成的事务，回滚未完成的事务  
xtrabackup --prepare --target-dir=/data/backups/  
2）复制到数据库目录  
注意：数据库目录必须为空，MySQL服务不能启动  
xtrabackup --copy-back --target-dir=/data/backups/  
3）还原属性  
chown -R mysql:mysql /var/lib/mysql  
4）启动服务(客户端记得加coket文件)  
systemctl start mariadb  

--xtrabackup增量备份及还原▲  
1 备份过程  
1）完全备份：xtrabackup --backup --target-dir=/backups/base  
2）第一次修改数据  
3）第一次增量备份  
xtrabackup --backup --target-dir=/backups/inc1 --incremental-
basedir=/backups/base  
4）第二次修改数据  
5）第二次增量  
xtrabackup --backup --target-dir=/backups/inc2 --incremental-
basedir=/backups/inc1  
6）scp -r /backups/* 目标主机:/backups/  
备份过程生成三个备份目录  
/backups/{base，inc1，inc2}  
2还原过程  
1）预准备完成备份，此选项--apply-log-only 阻止回滚未完成的事务  
xtrabackup --prepare --apply-log-only --target-dir=/backups/base  
2）合并第1次增量备份到完全备份，  
xtrabackup --prepare --apply-log-only --target-dir=/backups/base  
--incremental-dir=/backups/inc1  
3）合并第2次增量备份到完全备份：最后一次还原不需要加选项--apply-
log-only  
xtrabackup --prepare --target-dir=/backups/base --incremental-
dir=/backups/inc2  
4）复制到数据库目录，注意数据库目录必须为空，MySQL服务不能启动  
xtrabackup --copy-back --target-dir=/backups/base 合并的备份数据   
5）还原属性：chown -R mysql:mysql /var/lib/mysql  
6）启动服务：systemctl start mariadb    

单表恢复不常用，有依赖关系，会导致数据不同步，mariadb 5.5版本不支
持单表恢复  


--mysql复制  
MySQL的扩展:  
   读写分离  
   复制：每个节点都有相同的数据集  
             向外扩展  
             二进制日志  
             单向(主服务器)  

复制的功用：  
数据分布/负载均衡读/备份/高可用和故障切换/MySQL升级测试  
主从复制原理：  
主--数据跟新--写入事务日志/binlog日志--发送slave服务线程（dump）   
从--io thread接收--写入realylog--用sql thread线程--数据跟新  

17主服务器配置：  
主节点配置：  
启用二进制日志并添加配置，设置一个全局惟一ID号，重启服务  
（从不服务器可不启用二进制日志）  
[mysqld]  
server-id=1 可不加   
log_bin=PATH  
创建有复制权限的用户账号  
grant replication slave on *.* to repluser@'192.168.34.%' identified by 'centos'  
授权复制权限给slave，允许任何内容发生变化都可以给repluser用户的主
机范围，授权口令centos  
  
27从服务器配置：  
启动中继日志，设置一个全局惟一ID号，设置数据库只读，重启服务   
[mysqld]  
server_id=#   
read_only=ON  
----------------↓可不加  
relay_log=relay-log relay log的文件路径，默认值hostname-relay-bin    
relay_log_index=relay-log.index 默认值hostname-relay-bin.index
使用有复制权限的用户账号连接至主服务器，并启动复制线程  
>CHANGE MASTER TO    
  >MASTER_HOST='192.168.34.%', 主机  
  >MASTER_USER='repluser',  用户名  
  >MASTER_PASSWORD='centos', 密码  
  >MASTER_PORT=3306, 端口  
  >MASTER_LOG_FILE='mysql-bin.000003', 二进制日志文件名  
  >MASTER_LOG_POS=245, 复制文件  
  >START SLAVE;  开启复制！！  
>show slave status\G 查看从节点状态     
>show processlist; 查看复制的线程  
#>help change master to ↑有现成范例  

新建从服务器并同步数据：  
主：  
mysqldump -A -F --single-transaction --master-data=1 > 
/data/all_bak.sql    
完全备份，刷新日志，事务方式存放，记录日志位置和对应的文件名，备
份到相应目录  
scp  /data/all_bak.sql 192.168.34.37:/data/   复制备份二进制日志  
  
从：  
yum install mariadb-server -y  
[mysql]  开启服务并且配置  
server-id=3    
read-only  管理员照样可读  
vim /data/all_bak.sql   (复制相应文件到下面↓↓↓)  
#CHANGE MASTER TO  
  >MASTER_HOST='192.168.34.%', 主机      
  >MASTER_USER='repluser',  用户名  
  >MASTER_PASSWORD='centos', 密码  
  >MASTER_PORT=3306, 端口  
 #MASTER_LOG_FILE='mysql-bin.00005',MASTER_LOG_POS=245;   
mysql < all_bak.sql  导入备份  
>start slave; 启动复制  
>show slave status\G;  查看状态  
>show databases; 验证数据库  
(后期开机自启实现自动复制,当主断开后,从默认每60秒发起重连请求)▲  
  
替换旧的主，新的从替代主复制：  
从替代主：  
>stop slave;  
>reset slave all;  
>show slave status\G  
vim /etc/my.cnf  
删除read-only，添加log-bin 和 binlog_format=row，并重启服务  
>show master logs; 查看日志位置  

其他从：  
>stop slave;  
>reset slave all;  
>CHANGE MASTER TO  
  >MASTER_HOST='192.168.34.17', 主机      
  >MASTER_USER='repluser',  用户名  
  >MASTER_PASSWORD='centos', 密码  
  >MASTER_PORT=3306, 端口  
>MASTER_LOG_FILE='mysql-bin.00001',MASTER_LOG_POS=245;  
>start slaeve;  
>show slave status\G 验证  
\------------------------------------------  
  
cat master.info ：复制主服务器要用的账户和配置信息  
cat relay-log.info ：日志位置和文件编号的对应关系  
  
>stop slave; 停止线程   
>show slave status\G  查看slave状态  
>show processlist; 查看复制线程  
>reset slave;  清除master.infor ,relay-log.info等同步信息,开始新的relay log , 需要先stop slave  
>reset slave all; 清除所有从服务器设置的主服务配置信息,先stop slave  
#建议从服务器随后把配置文件删除，然后启用log-bin二进制日志  

  
  
实验：
1）xtranbackup 备份  
2）主从复制；替换旧的主，新的从替代主复制    
3）一个主，两个从，主down机，启用新主   

  
如果要启用级联复制,需要在从服务器启用以下配置  
[mysqld]  
log_bin=PATH  配合下面选项↓  
log_slave_updates  从主节点复制二进制日志  
  
-- 级联复制▲  
主17   级联：27    从：37     
log_slave_updates   启用从服务器记录二进制日志  
17：删除数据库重启服务  
reset master; 清除所有二进制日志  
>grant replication slave on *.* to rpl@'192.168,34,%' identfied by 'centos';  创建账号  
vim /etc/my.cnf  
server-id=1  
log-bin=/data/lobin/mysql-bin  
binlog_format=row  
27:   
 vim /etc/my.cnf 添加配置文件并重启服务  
log_slave_updates ▲  
log-bin  
binlog-fromat=row  
read-only  
server-id=1  
>change master to  
>master_host='192.168.34.17',  
>master_user='rpl',  
>master_password='centos',  
>master_port=3306,  
>master_log_file='mysql-bin.000001',  
>master_log_pos=245,   
>start slave;  
>show slave status\G 查看状态   
>show databases; 查看是否同步  
17：  
mysql < hellodb  
37：  
vim /etc/my.cnf 添加配置文件并重启服务   
	  
read-only  
>change master to  
>master_host='192.168.34.27',  
>master_user='rpl',  
>master_password='centos',  
>master_port=3306,  
>master_log_file='mariadb-bin.000001',  
>master_log_pos=245  
>start slave;  
>show status slave\G  
  
复制架构应该注意的问题：  
1）  
从服务器上设置read_only=ON  
阻止所有用户, 包括主服务器复制的更新 ↓  
mysql> flush tables with read lock;  加读锁   
2）  
reset slave 清除设置的主服务器同步信息，先stop slave  
reset slave all 清除所有从服务器设置的主服务配置信息，先stop slave  
3）  
sql_slave_skip_counter = N 从服务器忽略几个主服务器的复制事件，   
（stop slave；停止在开启slave，然后重启修改）  
4）  
如何保证主从复制的事务安全  
参看https://mariadb.com/kb/en/library/server-system-variables/  
在master节点启用参数：  
sync_binlog=1 每次写后立即同步二进制日志到磁盘，性能差  
如果用到的为InnoDB存储引擎：  
innodb_flush_log_at_trx_commit=1 每次事务提交立即同步日志写磁盘  
innodb_support_xa=ON 默认值，分布式事务MariaDB10.3.0废除  
sync_master_info=#    #次事件后master.info同步到磁盘  
在slave节点启用服务器选项：  
skip_slave_start=false    slave：开机自启   true：禁止开机自启  
在slave节点启用参数：   
sync_relay_log=# #次写后同步relay log到磁盘  
sync_relay_log_info=# #次事务后同步relay-log.info到磁盘  

grant replication  
--主主复制  
主主复制：互为主从  
容易产生的问题：数据不一致；因此慎用  
考虑要点：自动增长id  
配置一个节点使用奇数id  
auto_increment_offset=1 开始点  
auto_increment_increment=2 增长幅度  
另一个节点使用偶数id  
auto_increment_offset=2  
auto_increment_increment=2  
  
主主复制的配置步骤：  
(1) 各节点使用一个惟一server_id  
(2) 都启动binary log和relay log  
(3) 创建拥有复制权限的用户账号  
(4) 定义自动增长id字段的数值范围各为奇偶  
(5) 均把对方指定为主节点，并启动复制线程  
例：主主复制实验  
17：修改配置并重新启动  
server-id=1  
log-bin=/PATH  
auto_increment_offset=1  
auto_increment_increment=2  
27：修改配置并重新启动  
server-id=2  
log-bin=/PATH  
auto_increment_offset=2  
auto_increment_increment=2  
17：  
>grant replication slave on *.* to rpl@'192.168.34.%' identified by 'centos';  
27：  
>change master to  
...地址指向17  
>start slave;  
cat relay-log.info relay-log.info 查看配置项记录值  

主主替换  
17：  
>change master to  
...地址指向27  
>start slave;  
>show start slave\G  
17 :  
>start slave 开启然后加记录验证  
  
--半同步复制  
不确保所有从服务器同步，只要有一个成功就行，如果超时（默认10秒）  

也会返回成功结果，单独装软件模块实现此功能  
rpm -ql mariadb-server 可查该模块
/usr/lib64/mysql/plugin/semisync_master.so  
/usr/lib64/mysql/plugin/semisync_slave.so  


半同步复制实现：▲  
主服务器配置:（配置，删库，重启服务）  
vim /etc/my.cnf  
#server-id=1  
#log-bin   
#binlog_format=row  
>grant replication slave on *.* to rpl@'192.168.34.%' identified by 'centos';  
------------------↑先实现主从复制  
>show plugins; 查看系统默认插件 （NULL表示系统默认已安装）  
> INSTALL PLUGIN rpl_semi_sync_master SONAME   

'semisync_master.so';   
安装rpl_semi_sync_master插件，文件名是semisync_master.so  
>SET GLOBAL rpl_semi_sync_master_enabled=1;   
启用插件（建议保存到配置文件）  
重启服务生效  
>SET GLOBAL rpl_semi_sync_master_timeout = 1000;  
设置超时时长为1s (毫秒为单位)   
>SHOW GLOBAL VARIABLES LIKE '%semi%'; 查看相关变量和状态值  
>SHOW GLOBAL STATUS LIKE '%semi%‘; 查看状态值  

从服务器配置:（配置，删库，重启服务）  
vim /etc/my.cnf  
#server-id=2   
#read-only    
>change master to  
>master_host='192.168.34.17',  
>master_user='rpl',  
>master_password='centos',  
>master_port=3306,  
>master_log_file='mariadb-bin.000001',  
>master_log_pos=245  
>start slave;  
>show slave status\G 查看状态验证  
------------------↑先实现主从复制  
> INSTALL PLUGIN rpl_semi_sync_slave SONAME 'semisync_slave.so';  
安装插件  
> SET GLOBAL rpl_semi_sync_slave_enabled=1;   
启用此插件（建议保存到配置文件）  
>show plugins; 查看插件  
>select @@rpl_semi_sync_slave_enabled; 查看状态值  
>show global status like '%semi%'; 查看相关变量和状态值  
>stop slave;   
>start slave;  
重启服务生效  



--复制过滤器  
让从节点仅复制指定的数据库，或指定数据库的指定表  
两种实现方式：  
(1) 服务器选项：主服务器仅向二进制日志中记录与特定数据库相关的事件  
注意：此项和binlog_format相关  
参看：https://mariadb.com/kb/en/library/mysqld-options/#-binlog-
ignore-db  
binlog_do_db = 数据库白名单列表，多个数据库需多行实现  
binlog_ignore_db = 数据库黑名单列表  
问题：基于二进制还原将无法实现；不建议使用  
(2) 从服务器SQL_THREAD在replay中继日志中的事件时，仅读取与特定数
据库(特定表)相关的事件并应用于本地  
问题：会造成网络及磁盘IO浪费  

从服务器上的复制过滤器相关变量  ▲(2) 推荐使用  
>show variables like 'replicate%'; 显示相关变量  
replicate_do_db= 指定复制库的白名单  
replicate_ignore_db= 指定复制库黑名单  
replicate_do_table= 指定复制表的白名单  
replicate_ignore_table= 指定复制表的黑名单  
replicate_wild_do_table= foo%.bar% 支持通配符  
replicate_wild_ignore_table=  
（如果写白名单，后期没在白名单的默认不复制，配置重启服务生效）  

>show master status; 列出最新的二进制日志位置，及数据过滤器的白名  
  
单黑名单  
>show master logs; 列出所有二进制日志位置  
建议配置在从服务器上，避免后期恢复二进制日志  


--MySQL复制加密 (通过ssl加密同步)▲  
主服务器：  
mkdir /etc/my.cnf.d/ssl 建立证书文件夹  
cd /etc/my.cnf.d/ssl  
(umask 066;openssl genrsa 2048 > cakey.pem )生成私钥文件并行执行  
openssl req -new -x509 -key cakey.pem -out cacert.pem -days 3650  
利用cakey私钥文件生成cacert.pemCA自签名证书文件，有效期10年；  
↓   
(CN;beijing;beijing;magedu;devops;ca.magedu.com)  
openssl req -newkey rea:2048 -day 365 -nodes -keyout master.key > master.csr  
生成私钥master.key，有效期1年，利用私钥生成证书申请文件     
（cacert.pem证书 ； master.key私钥 ； master.csr证书申请文件 ）  

openssl  req -newkey rsa:2048 -days 365 -nodes -keyout slave.key > slave.csr   
(CN;beijing;beijing;magedu;devops;ca.magedu.com)   
生成私钥slave.key，有效期1年，利用私钥生成slave.csr证书申请文件  

openssl x509 -req -in master.csr -CA cacert.pem -CAkey cakey.pem 
-set_serial 01 > master.crt（证书文件）  
利用CA信息，同时指定证书编号，默认1年，生成master.csr证书  

openssl x509 -req -in slave.csr -CA cacert.pem -CAkey cakey.pem -
set_serial 02 > slave.crt（证书文件）  
利用CA信息，同时指定证书编号，默认1年，生成slave.csr证书  

openssl x509 -in master.crt  -noout --text;查看颁发的证书内容  
openssl verify -CAfile cacert.pem master.crt slave.crt  
验证颁发证书的有效性  

vim /etc/my.cnf 添加ssl配置并重启服务  
#log-bin  
#server-id   
#ssl （只要指定ssl路径，可不加也会开启）  
#ssl-ca=/etc/my.cnf.d/ssl/cacert.pem  
#ssl-cert=/etc/my.cnf.d/ssl/master.crt  
#ssl-key=/etc/my.cnf.d/ssl/master.key  
show variables like '%ssl%'; 查看ssl相关变量及是否启用ssl  
>grant replication slave on *.* to rplssl@192.168.34.% identified by 'cenots' require ssl;   
授权复制权限给从服务器，并创建rplssl账户可复制任何数据，指定此用户必须用ssl加密方式访问  


从服务器：  
mkdir /etc/my.cnf.d/ssl/  
scp cacert.pem slave.crt slave.key    192.68.34.27:/etc/my.cnf.d/ssl/  
复制证书和私钥文件  
show variables like '%ssl%'; 查看ssl相关变量  

mysql -u rplssl -p centos -h 192.168.34.17   
--ssl-ca=/etc/my.cnf.d/ssl/cacert.pem   
--ssl-cert=/etc/my.cnf.d/ssl/slave.crt  
--ssl-key=/etc/cmy.cnf.d/ssl/slave.key  
通过证书文件，私钥文件配合CA证书来连接到主数据库  
>status; 可验证是否使用ssl加密连接  

>stop slave;  
>reset slave all; 清除连接主服务器的所有配置信息  
>CHANGE MASTER TO  
>MASTER_HOST='MASTERIP',  
>MASTER_USER='rep',  
>MASTER_PASSWORD='centos',  
>MASTER_LOG_FILE='mariadb-bin.000001',   
>MASTER_LOG_POS=245,  
>MASTER_SSL=1,   要求加密  
>MASTER_SSL_CA = '/etc/my.cnf.d/ssl/cacert.pem',  
>MASTER_SSL_CERT = '/etc/my.cnf.d/ssl/slave.crt',  
>MASTER_SSL_KEY = '/etc/my.cnf.d/ssl/slave.key';  
>show slave status\G  查看并验证  
>start slave;  
  

--复制的监控和维护  
1）  
>purge master logs to 'mariadb-bin.000007' ; 清理7之前的日志  
>reset master; 二进制日志从000001开始编号  
>reset slave 重新生成配置  
2）复制监控  
show master status    列出最新的二进制日志位置，及数据过滤器的白名
单黑名单    
show binlog events   查看二进制日志  
show binary logs      查看二进制记录位置  
show slave status    查看slave状态  
show processlist     查看进程列表   
3） 从服务器是否落后于主服务  
Seconds_Behind_Master: 0  
4） 如何确定主从节点数据是否一致  
percona-tools  
5） 数据不一致如何修复  
删除从数据库，重新复制  

--mysql 读写分离  
读写分离应用：  
mysql-proxy：Oracle，https://downloads.mysql.com/archives/proxy/  
Atlas：Qihoo，https://github.com/Qihoo360/Atlas/blob/master/README_ZH.md  
dbproxy：美团，https://github.com/Meituan-Dianping/DBProxy  
Cetus：网易乐得，https://github.com/Lede-Inc/cetus  
Amoeba：https://sourceforge.net/projects/amoeba/  
Cobar：阿里巴巴，Amoeba的升级版  
Mycat：基于Cobar， http://www.mycat.io/  
ProxySQL：https://proxysql.com/  
官方手册：https://github.com/sysown/proxysql/wiki  

ProxySQL安装（5.5.30）  
内置小的数据库，提供配置数据库，增删改就可以管理mysql  
6032 管理端口     
6033 对外提供服务的端口，用户应用程序访问  
默认管理员账号密码：admin admin  

基于YUM仓库安装  
cat <<EOF | tee /etc/yum.repos.d/proxysql.repo  
[proxysql_repo]  
name= ProxySQL YUM repository  
baseurl=http://repo.proxysql.com/ProxySQL/proxysql-1.4.x/centos/
\$releasever  
gpgcheck=1  
gpgkey=http://repo.proxysql.com/ProxySQL/repo_pub_key  
EOF  
或  
基于RPM下载安装：https://github.com/sysown/proxysql/releases  

yum install proxysql -y  
rpm -ql proxysql  
ProxySQL组成  
服务脚本：/etc/init.d/proxysql  
配置文件：/etc/proxysql.cnf  
主程序：/usr/bin/proxysql  
service proxysql start  启动服务  
mysql -u admin -p admin -h 127.0.0.1 -p  6032 连接测试  
>use main;  
>show tables;   
说明：在main和monitor数据库中的表， runtime_开头的是运行时的配置
，不能修改，只能修改非runtime_表，修改后必须执行LOAD … TO   

RUNTIME才能加载到RUNTIME生效，执行save … to disk将配置持久化  

保存到磁盘  

内置账号 admin admin  
>status;    
>use main;  
>load ...to runtime  加载到runtime生效  
>save ... to disk 将配置保存到磁盘  

--MySQL实现读写分离(7代理 17主 27读 37读)  
7：  
向ProxySQL中添加MySQL节点，以下操作不需要use main也可成功  
use main；mysql_servers 表▲  
> select * from mysql_servers;  
> insert into mysql_servers(hostgroup_id,hostname,port) values  

(10,'192.168.34.17',3306);  
> insert into mysql_servers(hostgroup_id,hostname,port) values  

(10,'192.168.34.27',3306);  
> insert into mysql_servers(hostgroup_id,hostname,port) values  

(10,'192.168.34.37',3306);  
> load mysql servers to runtime; 加载myslq servers表生效  
> save mysql servers to disk; 保存到磁盘  
use main；global_variables 表▲  
>select * from global_variables 查看信息   
配置监控  
> set mysql-monitor_username='monitor';  
> set mysql-monitor_password='magedu';  
加载到RUNTIME，并保存到disk  
> load mysql variables to runtime;  
> save mysql variables to disk;  
>select * from mysql_servers\G  查看监控的服务器是否在线  
>select * from mysql_server_ping_log;  
查看监控心跳信息 (对ping指标的监控)  
>select * from mysql_server_connect_log;  
查看监控连接是否正常，null为正常(对connect指标的监控)  
> select * from mysql_server_read_only_log; 读日志  
> select * from mysql_server_replication_lag_log; 复制日志  

use main；mysql_replication_hostgroups 表▲  
>insert into mysql_replication_hostgroups values(10,20,"test");  
设置10为写组，20为读组，test为描述信息  
>select * from mysql_replication_hostgroups 查看表信息验证  
（Monitor模块监控后端的read_only值，按照read_only的值将节点自动  

移动到读/写组）  
>select hostgroup_id,hostname,port,status,weight from   

mysql_servers;   
查看读/写组表信息，看是否自动变更！！  
 
use monitor；mysql_users 表▲  
>insert into mysql_users(username,password,default_hostgroup)   

values('sqluser','magedu',10);  
load mysql users to runtime;  
save mysql users to disk;  
将用户sqluser添加到mysql_users表中， default_hostgroup默认组设置  

为写组10，当读写分离的路由规则不符合时，会访问默认组的数据库  
>load mysql users to runtime;  加载到runtime生效 
>save mysql users to disk; 写入磁盘   

>myslq -u sqluser -p magedu -h 127.0.0.1 -p 6033 
连接prox服务器并验证！！  
>select @@server_id; 可查看在哪个数据库（默认数据库主机组）  
 
use monitor；mysql_query_rulesb表▲   
insert into mysql_query_rules  
(rule_id,active,match_digest,destination_hostgroup,apply)VALUES  
(1,1,'^SELECT.*FOR UPDATE$',10,1),(2,1,'^SELECT',20,1);  
load mysql query rules to runtime;  
save mysql query rules to disk;  
插入路由规则：将select语句分离到20的读组，select语句中有一个特殊语
句SELECT...FOR UPDATE它会申请写锁，应路由到10的写组  
load mysql query rules to runtime; 写入 runtime生效  
save mysql query rules to disk;  保存到磁盘  

use main|stats库中；stats_mysql_query_digest 表▲  
SELECT hostgroup hg,sum_time, count_star, digest_text FROM   

stats_mysql_query_digest ORDER BY sum_time DESC;  
查看执行的命令在哪些对应组的数据库上操作，并统计执行时间和计数  

测试验证：  
测试读操作是否路由给20的读组  
mysql -usqluser -pmagedu -P6033 -h127.0.0.1 -e 'select
@@server_id'  
测试写操作，以事务方式进行测试  
mysql -usqluser -pmagedu -P6033 -h127.0.0.1 \
-e 'start transaction; select @@server_id;commit;select @@server_id'   
mysql -usqluser -pmagedu -P6033 -h127.0.0.1 -e 'insert testdb.test values (1)'  

17主：  
>grant replication client on *.* to monitor@'192.168.34.%' identified   

by 'magedu'; 创建复制监控账号  
>grant all on *.* to sqluser@'192.168.8.%' identified by 'magedu';  
创建访问用户  

27,37从：  
vim /etc/my.cnf 必加项  
#read_only   


--mysql 高可用（故障切换） 基于主从复制实现的基础上配置  
MHA： Master High Availability，对主节点进行监控，可实现自动故障
转移至其它从节点；通过提升某一从节点为新的主节点，基于主从复制实
现，还需要客户端配合实现，目前MHA主要支持一主多从的架构，要搭建
MHA,要求一个复制集群中必须最少有三台数据库服务器，一主二从，即一
台充当master，一台充当备用master，另外一台充当从库，出于机器成本
的考虑，淘宝进行了改造，目前淘宝TMHA已经支持一主一从  
官网:https://code.google.com/archive/p/mysql-master-ha/  

--MHA工作原理  
1 从宕机崩溃的master保存二进制日志事件（binlog events）  
2 识别含有最新更新的slave  
3 应用差异的中继日志（relay log）到其他的slave  
4 应用从master保存的二进制日志事件（binlog events）  
5 提升一个slave为新的master  
6 使其他的slave连接新的master进行复制 

--MHA软件由两部分组成，Manager工具包和Node工具包  
Manager工具包：管理mysql集群  
Node工具包：被管理的节点  

Manager工具包主要包括以下几个工具：  
masterha_check_ssh 检查MHA的SSH配置状况  
masterha_check_repl 检查MySQL复制状况  
masterha_manger 启动MHA  
masterha_check_status 检测当前MHA运行状态   
masterha_master_monitor 检测master是否宕机  
masterha_master_switch 故障转移（自动或手动）  
masterha_conf_host 添加或删除配置的server信息  

Node工具包：这些工具通常由MHA Manager的脚本触发，无需人为操作

主要包括以下几个工具：   
save_binary_logs 保存和复制master的二进制日志  
apply_diff_relay_logs 识别差异的中继日志事件并将其差异的事件应用于
其他的slave filter_mysqlbinlog 去除不必要的ROLLBACK事件  
（MHA已不再使用此工具）  
purge_relay_logs 清除中继日志（不会阻塞SQL线程）  
注意：为了尽可能的减少主库硬件损坏宕机造成的数据丢失，因此在配置  

MHA的同时建议配置成MySQL 5.5的半同步复制  

【实验】  
(7监控；17主；27,37从)  

7监控_管理者：▲  
ntpdate 172.18.0.1  同步时间  
ssh-keygen 生成秘钥对（公钥/私钥）  
ssh-copy-id 192.168.34.7；yes；密码    
把公钥复制到本机authorized_keys文件  
scp -rp /root/.ssh 182.168.34.17;/root/    
scp -rp /root/.ssh 182.168.34.27;/root/ 把目录到其他主机  
ssh  192.168.34.27 基于key登录验证  
rz mha4mysql-manager-0.56-0.el6.noarch.rpm  拷贝软件包  
rz mha4mysql-node-0.56-0.el6.noarch.rpm   拷贝软件包  
#在管理节点上安装两个包：(有些工具依赖于epel源)  
#mha4mysql-manager  
#mha4mysql-node  
yum install mha4mysql-manager-0.56-0.el6.noarch.rpm  
yum install mha4mysql-node-0.56-0.el6.noarch.rpm  
\--------------------------------------------  
实现MHA  
在管理节点建立配置文件  
vim /etc/mastermha/app1.cnf  
[server default]  
user=mhauser  管理监控节点账号  
password=magedu    
manager_workdir=/data/mastermha/app1/ 自动生成  
manager_log=/data/mastermha/app1/manager.log 自动生成  
remote_workdir=/data/mastermha/app1/ 在远端服务器自动生成  
ssh_user=root 管理员账号  
repl_user=rpluser  复制权限账户  
repl_password=centos  
ping_interval=1  测试间隔  
#被管理的节点信息  
[server1]  
hostname=192.168.8.17  
candidate_master=1  
[server2]  
hostname=192.168.8.27  
candidate_master=1  
[server3]  
hostname=192.168.8.37  
\-------------------------------------------  
在所有节点实现相互之间ssh key验证  
Mha验证和启动，测试↓  
masterha_check_ssh --conf=/etc/mastermha/app1.cnf 检查配置  
masterha_check_repl --conf=/etc/mastermha/app1.cnf 检查配置  
masterha_manager --conf=/etc/mastermha/app1.cnf 前台启动  
（主服务器宕机自动提升从服务器，只提升一次就结束脚本，建议后台执
行）  
排错日志：  
/data/mastermha/app1/manager.log  

#发大量记录，然中断17主服务器，根据配置27从自动接替主，  
#当17重新恢复，也不会重新恢复为主，可再配置更改为从  
#show slave status\G 可查看验证主信息  
#新主read_only 配置会自动OFF  
#调度器还需要重新配置vim /etc/mastermha/app1.cnf  
  
17主：▲  
ntpdate 172.18.0.1   
vim /etc/my.cnf 配置并重启服务  
#server-id=1  
#log-bin  
#skip-name-resolve=1 启用，忽略名称解析（ip解析成名称） 必加项  
#relay_log_purge=0 不清除，确认中继日志是否清除  
>show variables like 'skip%'; 查看是否开启  
>grant replication slave on *.* to rpluser@'192.168.34.%' identified   

by 'centos'; 创建有复制权限的账号  
>grant all on *.* to mhauser@'192.168.34.%’identified 
by‘magedu';   
创建管理者账号（在提升某个服务器为主时可自动关闭read_only配置）  
#在被管理节点安装：  
#mha4mysql-node  
rz  mha4mysql-node-0.56-0.el6.noarch.rpm  
yum install  mha4mysql-node-0.56-0.el6.noarch.rpm  
rpm -ql mha4mysql-manager    
#/usr/bin/masterha_manager  
#/usr/bin/masterhs_check_repl 测试脚本  
#/usr/bin/masterhs_check_ssh 测试脚本  
#/usr/bin/masterhs_check_status 测试脚本  


27,37从：▲  
ntpdate 172.18.0.1   
>change master to  
>master_host='192.168.34.17',  
>master_user='rpl',  
>master_password='centos',  
>master_port=3306,  
>master_log_file='mariadb-bin.000001',  
>master_log_pos=245  
>start slave;  
>show slave status\G  确认slave运行状态  
-------------  
>show variables like 'relay_log_purge';  确认中继日志清除是否开启  
vim /etc/my.cnf  配置并重启服务  
#server-id=2  
#log-bin  （后期可能替代主，所以要启用）  
#read-only  
#skip-name-resolve=1 启用  
#relay_log_purge=0  不启用清除中继日志功能  

#在被管理节点安装：  
#mha4mysql-node  
rz  mha4mysql-node-0.56-0.el6.noarch.rpm  
yum install  mha4mysql-node-0.56-0.el6.noarch.rpm  

▲▲▲  
Galera Cluster ：集成了Galera插件的MySQL集群（3台）  
多主架构：真正的多点读写的集群，在任何时候读写数据，都是最新的  
同步复制：集群不同节点之间数据同步，没有延迟，在数据库挂掉之后，
数据不会丢失  
并发复制：从节点APPLY数据时，支持并行执行，更好的性能  
故障切换：在出现数据库故障时，因支持多点写入，切换容易  
热插拔：在服务期间，如果数据库挂了，只要监控程序发现的够快，不可
服务时间就会非常少。在节点故障期间，节点本身对集群的影响非常小
自动节点克隆：在新增节点，或者停机维护时，增量数据或者基础数据不
需要人工手动备份提供，Galera Cluster会自动拉取在线节点数据，最终集
群会变为一致  
对应用透明：集群的维护，对应用程序是透明的  

--galera cluster  高可用集群 5.5.62 mariadb （7；17；27）  
7：  
vim /etc/yum.repos.d/mysql.repo  
[mysql]  
baseurl=https://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-
5.5.62/yum/centos7-amd64/  
gpgcheck=0   
(https://downloads.mariadb.org/需要确认版本 ↑↑↑)  
scp  /etc/yum.repos.d/mysql.repo 192.168.34.17:/etc/yum.repos.d/  
scp  /etc/yum.repos.d/mysql.repo 192.168.34.27:/etc/yum.repos.d/  
(安装前确保mariadb数据库已卸载↓↓↓)  
yum list MariaDB-Galera-server   
yum install MariaDB-Galera-server -y三台都要装  
vim /etc/my.cnf.d/server.conf  修改配置文件实现mysql复制  
[galera]  
wsrep_provider = /usr/lib64/galera/libgalera_smm.so 提供的程序路径  
wsrep_cluster_address="gcomm://192.168.34.7,192.168.34.17,192.168
.34.27"   集群服务器节点ip  
binlog_format=row  基于行的二进制日志  
default_storage_engine=InnoDB  默认存储引擎  
innodb_autoinc_lock_mode=2    
bind-address=0.0.0.0  
↓↓↓↓可选项  
#wsrep_cluster_name ='mycluster'默认my_wsrep_cluster 集群server名  
#wsrep_node_name = 'node1'   当前节点名称  
#wsrep_node_address = '192.168.8.7' 当前节点ip地址  
scp server.cnf 192.168.34.17:/etc/my.cnf.d/   复制配置文件到其他主机  
scp server.cnf 192.168.34.27:/etc/my.cnf.d/   
rpm -qf /etc/init.d/mysql  查看mysql启动服务来源包  
service mysql start --wsrep-new-cluster 启动第一个节点  
service mysql start  后续正常启动其它节点  
 
17；27 ：其他两个主机安装完并复制配置文件后 ↑↑↑  
service mysql restart 重启服务  
mysql登录验证  


查看集群中相关系统变量和状态变量  
SHOW VARIABLES LIKE 'wsrep_%‘;  
SHOW STATUS LIKE 'wsrep_%‘;  
SHOW STATUS LIKE 'wsrep_cluster_size‘;  
show variables  like 'max%';  查看并发连接  
当3台主机同时写记录，会自动错 位递增（3的步幅增加）  
会面临数据冲突的风险，会踢到数据不一致的节点，少数服从多数 
ulimit -n 10222  程序最大请求接入数量  

数据库服务衡量指标：    
qps: query per second  每秒支持多少个查询  
tps: transaction per second  每秒支持多少个事务  
压力测试工具：  
mysqlslap 系统自带  
Sysbench：功能强大  
https://github.com/akopytov/sysbench  
tpcc-mysql 
MySQL Benchmark Suite  
MySQL super-smack  
MyBench  

--mysql压力测试  
Mysqlslap：来自于mariadb包，测试的过程默认生成一个mysqlslap的
schema,生成测试表t1，查询和插入测试数据，mysqlslap库自动生成，如
果已经存在则先删除。用--only-print来打印实际的测试过程，整个测试完
成后不会在数据库中留下痕迹  
使用格式：mysqlslap [options]  
常用参数 [options] 说明：  
--auto-generate-sql, -a 自动生成测试表和数据，表示用mysqlslap工具  

自己生成的SQL脚本来测试并发压力  
--auto-generate-sql-load-type=type 测试语句的类型。代表要测试的环
境是读操作还是写操作还是两者混合的。取值包括：read，key，write，
update和mixed(默认)  
--auto-generate-sql-add-auto-increment 代表对生成的表自动添加
auto_increment列，从5.1.18版本开始支持  
--number-char-cols=N, -x N 自动生成的测试表中包含多少个字符类型
的列，默认1  
--number-int-cols=N, -y N 自动生成的测试表中包含多少个数字类型的
列，默认1  
--number-of-queries=N 总的测试查询次数(并发客户数×每客户查询次
数)  
--query=name,-q 使用自定义脚本执行测试，例如可以调用自定义的存储
过程或者sql语句来执行测试  
--create-schema 代表自定义的测试库名称，测试的schema   
--commint=N 多少条DML后提交一次  
--compress, -C 如服务器和客户端都支持压缩，则压缩信息  
--concurrency=N, -c N 表示并发量，即模拟多少个客户端同时执行
select。可指定多个值，以逗号或者--delimiter参数指定值做为分隔符  
如：--concurrency=100,200,500  
--engine=engine_name, -e engine_name 代表要测试的引擎，可以有
多个，用分隔符隔开。例如：--engines=myisam,innodb  
--iterations=N, -i N 测试执行的迭代次数，代表要在不同并发环境下，各
自运行测试多少次  
--only-print 只打印测试语句而不实际执行。  
--detach=N 执行N条语句后断开重连  
--debug-info, -T 打印内存和CPU的相关信息  


--生产环境my.cnf配置示例▲  
硬件：内存32G  
innodb_file_per_table = 1  
打开独立表空间  
max_connections = 8000 （/etc/my.cnf.d/server.cnf添加）  
每个程序打开的文件个数限制：（ulimit -n 10245 可增加）  
#MySQL 服务所允许的同时会话数的上限，经常出现Too Many   

Connections的错误提示，则需要增大此值  
back_log = 300  
#back_log 是操作系统在监听队列中所能保持的连接数  
max_connect_errors = 1000  
#每个客户端连接最大的错误允许数量，当超过该次数，MYSQL服务器将  

禁止此主机的连接请求，直到MYSQL服务器重启或通过flush hosts命令清
空此主机的相关信息  
open_files_limit = 10240  
#所有线程所打开表的数量    
max_allowed_packet = 32M  
#每个连接传输数据大小.最大1G，须是1024的倍数，一般设为最大的  
  
BLOB的值  
wait_timeout = 10  
#指定一个请求的最大连接时间  
sort_buffer_size = 16M  
#排序缓冲被用来处理类似ORDER BY以及GROUP BY队列所引起的排序  
join_buffer_size = 16M
#不带索引的全表扫描.使用的buffer的最小值  
query_cache_size = 128M  
#查询缓冲大小  
query_cache_limit = 4M  
#指定单个查询能够使用的缓冲区大小，缺省为1M  
transaction_isolation = REPEATABLE-READ  
#设定默认的事务隔离级别  
thread_stack = 512K  
#线程使用的堆大小. 此值限制内存中能处理的存储过程的递归深度和SQL  

语句复杂性，此容量的内存在每次连接时被预留.  
log-bin  
#二进制日志功能  
binlog_format=row  
#二进制日志格式    
innodb_buffer_pool_size = 24G  
#InnoDB使用一个缓冲池来保存索引和原始数据, 可设置这个变量到服务
器物理内存大小的80%   
innodb_file_io_threads = 4  
#用来同步IO操作的IO线程的数量  
innodb_thread_concurrency = 16  
#在InnoDb核心内的允许线程数量，建议的设置是CPU数量加上磁盘数量
的两倍  
innodb_log_buffer_size = 16M  
#用来缓冲日志数据的缓冲区的大小  
innodb_log_file_size = 512M  
在日志组中每个日志文件的大小  
innodb_log_files_in_group = 3  
#在日志组中的文件总数  
innodb_lock_wait_timeout = 120  
#SQL语句在被回滚前,InnoDB事务等待InnoDB行锁的时间  
long_query_time = 2  
#慢查询时长  
log-queries-not-using-indexes  
#将没有使用索引的查询也记录下来  



&emsp;  &nbsp;